<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Voxink</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #ffffff;
      --bg-sidebar: #f5f5f7;
      --bg-hover: rgba(0, 0, 0, 0.04);
      --bg-active: rgba(0, 0, 0, 0.06);
      --text-primary: #1d1d1f;
      --text-secondary: #6e6e73;
      --text-tertiary: #aeaeb2;
      --accent-green: #34c759;
      --accent-blue: #007aff;
      --border-subtle: rgba(0, 0, 0, 0.08);
      --border-divider: rgba(0, 0, 0, 0.06);
      --radius-lg: 12px;
      --radius-md: 8px;
      --radius-sm: 6px;
      --sidebar-width: 160px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      display: flex;
      -webkit-user-select: none;
      user-select: none;
    }

    /* ── Sidebar ── */
    .sidebar {
      width: var(--sidebar-width);
      min-width: var(--sidebar-width);
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .sidebar-drag {
      height: 52px;
      -webkit-app-region: drag;
      app-region: drag;
      flex-shrink: 0;
    }

    .sidebar-nav {
      flex: 1;
      padding: 0 12px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .nav-item {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .nav-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--bg-active);
      color: var(--text-primary);
      font-weight: 600;
    }

    .nav-icon {
      font-size: 16px;
      width: 20px;
      text-align: center;
      flex-shrink: 0;
    }

    .sidebar-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-divider);
    }

    .sidebar-version {
      font-size: 11px;
      color: var(--text-tertiary);
    }

    /* ── Content Area ── */
    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .content-drag {
      height: 52px;
      -webkit-app-region: drag;
      app-region: drag;
      flex-shrink: 0;
    }

    .content-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 0 36px 36px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .page-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.3px;
      color: var(--text-primary);
      margin-bottom: 24px;
    }

    /* ── Sections ── */
    .section {
      margin-bottom: 28px;
    }

    .section:last-child {
      margin-bottom: 0;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 16px;
    }

    .section-icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
      color: var(--text-secondary);
    }

    .section-icon svg {
      width: 18px;
      height: 18px;
      display: block;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-secondary);
    }

    .section-divider {
      height: 1px;
      background: var(--border-divider);
      margin-bottom: 28px;
    }

    /* ── Hotkey Display ── */
    .hotkey-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .keycaps {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    kbd {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 34px;
      height: 34px;
      padding: 0 10px;
      font-family: 'Inter', -apple-system, sans-serif;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.15);
      border-bottom: 2px solid rgba(0, 0, 0, 0.15);
      border-radius: var(--radius-sm);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    }

    kbd.accent {
      background: var(--bg-sidebar);
      border-color: rgba(0, 0, 0, 0.12);
      border-bottom-color: rgba(0, 0, 0, 0.18);
      color: var(--accent-blue);
      font-weight: 700;
    }

    .hotkey-btn {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      padding: 7px 16px;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      color: var(--text-secondary);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .hotkey-btn:hover {
      background: var(--bg-sidebar);
      color: var(--text-primary);
      border-color: rgba(0, 0, 0, 0.15);
    }

    /* ── Capturing State ── */
    .hotkey-capture {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      padding: 16px 0 4px;
    }

    .hotkey-capture.active {
      display: flex;
    }

    .hotkey-row.hidden {
      display: none;
    }

    .capture-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--accent-blue);
      animation: captureGlow 2s ease-in-out infinite;
    }

    @keyframes captureGlow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .capture-preview {
      display: flex;
      align-items: center;
      gap: 6px;
      min-height: 34px;
    }

    .capture-hint {
      font-size: 12px;
      color: var(--text-tertiary);
    }

    .capture-actions {
      display: flex;
      gap: 8px;
    }

    .capture-actions button {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      padding: 6px 14px;
      border-radius: var(--radius-sm);
      font-family: 'Inter', sans-serif;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
    }

    .btn-cancel {
      background: var(--bg-hover);
      color: var(--text-secondary);
    }

    .btn-cancel:hover {
      background: var(--bg-active);
      color: var(--text-primary);
    }

    .reset-btn {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      padding: 7px 16px;
      border: 1px solid rgba(255, 59, 48, 0.3);
      border-radius: var(--radius-sm);
      background: rgba(255, 59, 48, 0.08);
      color: #ff3b30;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .reset-btn:hover {
      background: rgba(255, 59, 48, 0.15);
      border-color: rgba(255, 59, 48, 0.4);
    }

    /* ── Confirm Modal ── */
    .confirm-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 2000;
    }

    .confirm-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .confirm-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }

    .confirm-card {
      position: relative;
      width: 320px;
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 0 0 1px var(--border-subtle);
      animation: confirmFadeIn 0.15s ease;
    }

    @keyframes confirmFadeIn {
      from { opacity: 0; transform: scale(0.96); }
      to { opacity: 1; transform: scale(1); }
    }

    .confirm-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .confirm-message {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .confirm-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .confirm-actions button {
      padding: 7px 16px;
      border-radius: var(--radius-sm);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border-subtle);
      transition: all 0.15s ease;
    }

    .confirm-cancel {
      background: var(--bg-primary);
      color: var(--text-secondary);
    }

    .confirm-cancel:hover {
      background: var(--bg-sidebar);
      color: var(--text-primary);
    }

    .confirm-destructive {
      background: #ff3b30;
      color: #fff;
      border-color: #ff3b30;
    }

    .confirm-destructive:hover {
      background: #e0352b;
      border-color: #e0352b;
    }

    /* ── History Page ── */
    .history-privacy-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: rgba(52, 199, 89, 0.06);
      border: 1px solid rgba(52, 199, 89, 0.15);
      border-radius: var(--radius-md);
      margin-bottom: 24px;
    }

    .history-privacy-icon {
      font-size: 18px;
      flex-shrink: 0;
    }

    .history-privacy-text {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .history-date-group {
      margin-bottom: 20px;
    }

    .history-date-header {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
      margin-bottom: 8px;
      padding-left: 4px;
    }

    .history-entry {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 12px;
      border-radius: var(--radius-md);
      transition: background 0.15s ease;
      position: relative;
    }

    .history-entry:hover {
      background: var(--bg-hover);
    }

    .history-time {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-tertiary);
      min-width: 44px;
      flex-shrink: 0;
      padding-top: 1px;
      font-variant-numeric: tabular-nums;
    }

    .history-content {
      flex: 1;
      min-width: 0;
    }

    .history-text {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.45;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .history-entry.clickable {
      cursor: pointer;
    }

    .history-detail-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 2000;
    }

    .history-detail-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .history-detail-card {
      position: relative;
      width: 480px;
      max-height: 80vh;
      overflow-y: auto;
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 0 0 1px var(--border-subtle);
      animation: confirmFadeIn 0.15s ease;
    }

    .history-detail-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 18px;
    }

    .history-detail-section {
      margin-bottom: 16px;
    }

    .history-detail-section:last-of-type {
      margin-bottom: 0;
    }

    .history-detail-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
      margin-bottom: 6px;
    }

    .history-detail-text {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.55;
      white-space: pre-wrap;
      word-break: break-word;
      background: var(--bg-sidebar);
      border-radius: var(--radius-md);
      padding: 10px 12px;
      -webkit-user-select: text;
      user-select: text;
    }

    .history-detail-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 18px;
    }

    .history-detail-actions button {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      padding: 7px 18px;
      border-radius: var(--radius-sm);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
      background: var(--bg-hover);
      color: var(--text-secondary);
    }

    .history-detail-actions button:hover {
      background: var(--bg-active);
      color: var(--text-primary);
    }

    .history-meta {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 4px;
      display: flex;
      gap: 8px;
    }

    .history-meta-item {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .history-menu-btn {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      background: none;
      border: none;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 18px;
      padding: 4px 6px;
      border-radius: var(--radius-sm);
      opacity: 0;
      transition: all 0.15s ease;
      flex-shrink: 0;
      line-height: 1;
    }

    .history-entry:hover .history-menu-btn {
      opacity: 1;
    }

    .history-menu-btn:hover {
      background: var(--bg-active);
      color: var(--text-primary);
    }

    .history-menu {
      display: none;
      position: absolute;
      right: 12px;
      top: 40px;
      background: var(--bg-primary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      z-index: 100;
      min-width: 140px;
      padding: 4px;
    }

    .history-menu.visible {
      display: block;
    }

    .history-menu-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      font-size: 13px;
      color: var(--text-primary);
      cursor: pointer;
      border-radius: var(--radius-sm);
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      transition: background 0.1s ease;
    }

    .history-menu-item:hover {
      background: var(--bg-hover);
    }

    .history-menu-item.destructive {
      color: #ff3b30;
    }

    .history-menu-item.destructive:hover {
      background: rgba(255, 59, 48, 0.08);
    }

    .history-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: var(--text-tertiary);
      text-align: center;
    }

    .history-empty-icon {
      font-size: 36px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .history-empty-text {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
      color: var(--text-secondary);
    }

    .history-empty-hint {
      font-size: 12px;
    }

    .history-settings {
      margin-bottom: 24px;
      padding: 16px;
      background: var(--bg-sidebar);
      border-radius: var(--radius-md);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .history-setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .history-setting-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .history-setting-desc {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }

    .history-select {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      padding: 6px 28px 6px 10px;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%236e6e73' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      min-width: 120px;
    }

    .history-select:hover {
      border-color: rgba(0, 0, 0, 0.15);
      background-color: #fff;
    }

    .history-select:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .history-storage-path {
      font-size: 11px;
      color: var(--text-tertiary);
      word-break: break-all;
      font-family: 'SF Mono', 'Menlo', monospace;
      background: var(--bg-primary);
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-divider);
      cursor: pointer;
      flex-shrink: 1;
      min-width: 0;
    }

    .history-storage-path:hover {
      border-color: rgba(0, 0, 0, 0.15);
    }

    .history-divider {
      height: 1px;
      background: var(--border-divider);
      margin-bottom: 20px;
    }

    /* ── Setting Rows ── */
    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .setting-row + .setting-row {
      margin-top: 16px;
    }

    .setting-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .setting-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .setting-desc {
      font-size: 12px;
      color: var(--text-tertiary);
    }

    /* ── Sub-settings ── */
    .sub-settings {
      display: none;
      margin-top: 16px;
      flex-direction: column;
      gap: 16px;
    }

    .sub-settings.visible {
      display: flex;
    }

    .sub-row {
      padding-left: 8px;
    }

    .sub-name {
      font-size: 13px;
    }

    /* ── Toggle Switch (macOS green) ── */
    .toggle {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      position: relative;
      width: 44px;
      height: 26px;
      flex-shrink: 0;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-track {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.12);
      border-radius: 13px;
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .toggle-track::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 22px;
      height: 22px;
      background: #ffffff;
      border-radius: 50%;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
    }

    .toggle input:checked + .toggle-track {
      background: var(--accent-green);
    }

    .toggle input:checked + .toggle-track::after {
      transform: translateX(18px);
    }

    /* ── Segmented Control ── */
    .segmented-control {
      display: flex;
      background: rgba(0, 0, 0, 0.06);
      border-radius: var(--radius-md);
      padding: 2px;
      gap: 2px;
    }

    .segmented-control button {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      flex: 1;
      padding: 7px 12px;
      border: none;
      border-radius: var(--radius-sm);
      background: transparent;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .segmented-control button.active {
      background: #ffffff;
      color: var(--text-primary);
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .segmented-control button:hover:not(.active) {
      color: var(--text-primary);
    }

    /* ── Cloud Config Inputs ── */
    .cloud-input {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      width: 100%;
      padding: 7px 12px;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      font-family: 'Inter', -apple-system, sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      background: var(--bg-primary);
      outline: none;
      transition: border-color 0.15s ease, background-color 0.15s ease;
    }

    .cloud-input:hover {
      border-color: rgba(0, 0, 0, 0.15);
      background-color: var(--bg-sidebar);
    }

    .cloud-input:focus {
      border-color: var(--accent-blue);
      background-color: var(--bg-primary);
    }

    .cloud-input::placeholder {
      color: var(--text-tertiary);
    }

    .provider-link-btn {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      flex-shrink: 0;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      color: var(--text-secondary);
      cursor: pointer;
      transition: border-color 0.15s ease, color 0.15s ease, background-color 0.15s ease;
    }

    .provider-link-btn:hover {
      border-color: var(--accent-blue);
      color: var(--accent-blue);
      background-color: var(--bg-sidebar);
    }

    .cloud-select {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      padding: 7px 28px 7px 12px;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      font-family: 'Inter', -apple-system, sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      background: var(--bg-primary);
      outline: none;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%236e6e73' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      min-width: 160px;
    }

    .cloud-select:hover {
      border-color: rgba(0, 0, 0, 0.15);
      background-color: var(--bg-sidebar);
    }

    .cloud-select:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .cloud-panel,
    .local-panel {
      display: none;
      flex-direction: column;
      gap: 16px;
      padding-top: 4px;
    }

    .cloud-panel.visible,
    .local-panel.visible {
      display: flex;
    }

    .cloud-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding-left: 8px;
    }

    .cloud-row .setting-info {
      min-width: 90px;
      flex-shrink: 0;
    }

    .cloud-row .cloud-input,
    .cloud-row .cloud-select {
      flex: 1;
      max-width: 280px;
    }

    /* ── About Page ── */
    .about-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding-top: 40px;
      gap: 6px;
    }

    .about-icon {
      width: 72px;
      height: 72px;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      margin-bottom: 12px;
    }

    .about-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .about-name {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.3px;
      color: var(--text-primary);
    }

    .about-version {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-bottom: 12px;
    }

    .about-desc {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
      max-width: 320px;
    }

    .about-engine {
      margin-top: 20px;
      font-size: 12px;
      color: var(--text-tertiary);
    }

    .about-update {
      margin-top: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .about-update-btn {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      padding: 7px 18px;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      color: var(--accent-blue);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .about-update-btn:hover {
      background: var(--bg-hover);
    }

    .about-update-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .about-update-btn.primary {
      background: var(--accent-blue);
      color: #ffffff;
      border-color: var(--accent-blue);
    }

    .about-update-btn.primary:hover {
      filter: brightness(1.1);
    }

    .about-update-status {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .about-update-status.error {
      color: #ff3b30;
    }

    .about-update-progress {
      width: 200px;
      height: 4px;
      border-radius: 2px;
      background: var(--bg-active);
      overflow: hidden;
    }

    .about-update-progress-bar {
      height: 100%;
      background: var(--accent-blue);
      border-radius: 2px;
      transition: width 0.2s ease;
      width: 0%;
    }

    .about-update-note {
      font-size: 11px;
      color: var(--text-tertiary);
      max-width: 300px;
      text-align: center;
      line-height: 1.4;
    }

    /* ── Mic status ── */
    .mic-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mic-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-green);
      flex-shrink: 0;
    }

    .mic-dot.disconnected {
      background: #ff3b30;
    }

    .mic-device.disconnected {
      color: #ff3b30;
    }

    .mic-select {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      padding: 7px 28px 7px 12px;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%236e6e73' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      min-width: 120px;
      max-width: 220px;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }

    .mic-select:hover {
      border-color: rgba(0, 0, 0, 0.15);
      background-color: var(--bg-sidebar);
    }

    .mic-select:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    /* ── Polish model download ── */
    .polish-model-card {
      padding: 0;
      background: none;
      border-radius: 0;
    }

    .polish-model-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .polish-model-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .polish-model-size {
      font-size: 12px;
      color: var(--text-tertiary);
    }

    .polish-download-btn {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      padding: 6px 14px;
      border: none;
      border-radius: var(--radius-sm);
      background: var(--accent-blue);
      color: #ffffff;
      font-family: 'Inter', sans-serif;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .polish-download-btn:hover {
      background: #0066d6;
    }

    .polish-download-btn.downloaded {
      background: var(--accent-green);
      cursor: default;
    }

    .polish-download-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .polish-progress-wrap {
      margin-top: 10px;
    }

    .polish-progress-track {
      width: 100%;
      height: 6px;
      background: rgba(0, 0, 0, 0.06);
      border-radius: 3px;
      overflow: hidden;
    }

    .polish-progress-fill {
      height: 100%;
      width: 0%;
      background: var(--accent-blue);
      border-radius: 3px;
      transition: width 0.15s ease;
    }

    .polish-progress-label {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-tertiary);
    }

    .lang-select {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      padding: 7px 28px 7px 12px;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%236e6e73' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      min-width: 140px;
    }

    .lang-select:hover {
      border-color: rgba(0, 0, 0, 0.15);
      background-color: var(--bg-sidebar);
    }

    .lang-select:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    /* ── Scrollbar ── */
    .content-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .content-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .content-scroll::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.12);
      border-radius: 3px;
    }

    .content-scroll::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.2);
    }

    /* ── Setup Overlay ── */
    .setup-overlay {
      position: fixed;
      inset: 0;
      z-index: 1000;
    }

    .setup-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .setup-card {
      position: relative;
      width: 420px;
      margin: 0 auto;
      top: 50%;
      transform: translateY(-50%);
      text-align: center;
      animation: setupFadeIn 0.4s ease;
    }

    @keyframes setupFadeIn {
      from { opacity: 0; transform: translateY(-50%) scale(0.96); }
      to { opacity: 1; transform: translateY(-50%) scale(1); }
    }

    .setup-overlay.fade-out {
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .setup-state { display: none; }
    .setup-state.active { display: block; }

    /* Mic illustration */
    .setup-mic-wrap {
      display: inline-block;
      position: relative;
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
    }

    .setup-mic-icon {
      position: relative;
      z-index: 2;
      animation: micFloat 3s ease-in-out infinite;
    }

    .setup-mic-wrap .wave {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 64px;
      height: 64px;
      margin: -32px 0 0 -32px;
      border-radius: 50%;
      border: 2px solid var(--accent-blue);
      opacity: 0;
      animation: waveExpand 3s ease-out infinite;
    }

    .setup-mic-wrap .wave:nth-child(2) { animation-delay: 1s; }
    .setup-mic-wrap .wave:nth-child(3) { animation-delay: 2s; }

    @keyframes micFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }

    @keyframes waveExpand {
      0% { transform: scale(0.8); opacity: 0.6; }
      100% { transform: scale(1.8); opacity: 0; }
    }

    /* Downloading state: pulse instead of float */
    #setupDownloading .setup-mic-icon,
    #setupLlmDownloading .setup-mic-icon {
      animation: micPulse 1.5s ease-in-out infinite;
    }

    @keyframes micPulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.06); opacity: 0.85; }
    }

    .setup-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.3px;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .setup-desc {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 24px;
      padding: 0 20px;
    }

    /* Permissions setup */
    .setup-permissions-list {
      text-align: left;
      margin: 0 auto 24px;
      max-width: 340px;
    }

    .setup-permission-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      margin-bottom: 8px;
    }

    .setup-permission-row:last-child {
      margin-bottom: 0;
    }

    .setup-permission-icon {
      flex-shrink: 0;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
    }

    .setup-permission-info {
      flex: 1;
      min-width: 0;
    }

    .setup-permission-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1px;
    }

    .setup-permission-desc {
      font-size: 11px;
      color: var(--text-tertiary);
    }

    .setup-permission-btn {
      flex-shrink: 0;
      padding: 5px 14px;
      background: var(--accent-blue);
      color: #ffffff;
      border: none;
      border-radius: var(--radius-sm);
      font-family: 'Inter', sans-serif;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .setup-permission-btn:hover {
      background: #0066d6;
    }

    .setup-permission-granted {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #34C759;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .setup-permission-granted svg {
      width: 14px;
      height: 14px;
    }

    .setup-continue-btn {
      display: inline-block;
      padding: 10px 28px;
      background: var(--accent-blue);
      color: #ffffff;
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Inter', sans-serif;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease, opacity 0.15s ease;
    }

    .setup-continue-btn:hover:not(:disabled) {
      background: #0066d6;
    }

    .setup-continue-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .setup-download-btn {
      display: inline-block;
      padding: 10px 28px;
      background: var(--accent-blue);
      color: #ffffff;
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Inter', sans-serif;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .setup-download-btn:hover {
      background: #0066d6;
    }

    .setup-skip-link {
      display: block;
      margin: 14px auto 0;
      font-size: 13px;
      color: var(--text-tertiary);
      text-decoration: underline;
      cursor: pointer;
      background: none;
      border: none;
      font-family: 'Inter', sans-serif;
    }

    .setup-skip-link:hover {
      color: var(--text-secondary);
    }

    .setup-polish-mode-control {
      margin: 12px auto 16px;
      width: fit-content;
    }

    .setup-polish-panel-desc {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 14px;
    }

    /* Progress bar */
    .setup-progress-wrap {
      margin: 0 20px 8px;
    }

    .setup-progress-track {
      width: 100%;
      height: 8px;
      background: rgba(0, 0, 0, 0.06);
      border-radius: 4px;
      overflow: hidden;
    }

    .setup-progress-fill {
      height: 100%;
      width: 0%;
      background: var(--accent-blue);
      border-radius: 4px;
      transition: width 0.15s ease;
      position: relative;
      overflow: hidden;
    }

    .setup-progress-fill::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.3) 50%,
        transparent 100%
      );
      animation: shimmer 1.5s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .setup-progress-label {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-tertiary);
    }

    /* Success icon */
    .setup-success-icon {
      display: inline-block;
      margin-bottom: 16px;
      animation: iconPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* Error icon */
    .setup-error-icon {
      display: inline-block;
      margin-bottom: 16px;
      animation: iconPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes iconPop {
      0% { transform: scale(0); }
      100% { transform: scale(1); }
    }

    .setup-error-msg {
      font-size: 13px;
      color: #ff3b30;
      margin-bottom: 20px;
      padding: 0 20px;
      word-break: break-word;
    }

    .setup-retry-btn {
      display: inline-block;
      padding: 10px 28px;
      background: var(--accent-blue);
      color: #ffffff;
      border: none;
      border-radius: var(--radius-md);
      font-family: 'Inter', sans-serif;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .setup-retry-btn:hover {
      background: #0066d6;
    }

    /* ── Test Wizard ── */
    .test-page {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 52px);
    }

    .test-breadcrumb {
      display: flex;
      align-items: center;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-divider);
      margin-bottom: 0;
      flex-shrink: 0;
    }

    .test-breadcrumb-item {
      flex: 1;
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-tertiary);
      cursor: default;
    }

    .test-breadcrumb-item.active {
      color: var(--text-primary);
      font-weight: 600;
    }

    .test-breadcrumb-item.done {
      color: var(--accent-blue);
    }

    .test-breadcrumb-sep {
      font-size: 12px;
      color: var(--text-tertiary);
      flex-shrink: 0;
    }

    .test-progress-bar {
      height: 3px;
      background: var(--border-divider);
      border-radius: 2px;
      margin-bottom: 0;
      flex-shrink: 0;
      overflow: hidden;
    }

    .test-progress-fill {
      height: 100%;
      background: var(--accent-blue);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .test-step {
      display: none;
      flex: 1;
      min-height: 0;
    }

    .test-step.active {
      display: flex;
      flex-direction: column;
    }

    .test-layout {
      display: flex;
      flex: 1;
      gap: 0;
      min-height: 0;
    }

    .test-left {
      flex: 0 0 340px;
      display: flex;
      flex-direction: column;
      padding: 24px 28px 24px 0;
    }

    .test-left-spacer {
      flex: 1;
    }

    .test-right {
      flex: 1;
      background: #f5f5f7;
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 16px 0;
      min-width: 0;
      overflow: hidden;
    }

    .test-back {
      font-size: 13px;
      color: var(--accent-blue);
      cursor: pointer;
      border: none;
      background: none;
      padding: 0;
      margin-bottom: 12px;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      -webkit-app-region: no-drag;
      align-self: flex-start;
      flex-shrink: 0;
    }

    .test-back:hover {
      text-decoration: underline;
    }

    .test-title {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.3px;
      color: var(--text-primary);
      margin-bottom: 8px;
      line-height: 1.3;
    }

    .test-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 24px;
      line-height: 1.5;
    }

    .test-question {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
    }

    .test-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .test-btn-outline {
      -webkit-app-region: no-drag;
      padding: 10px 20px;
      border: 1.5px solid rgba(0, 0, 0, 0.15);
      border-radius: 100px;
      background: none;
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .test-btn-outline:hover {
      background: var(--bg-hover);
      border-color: rgba(0, 0, 0, 0.25);
    }

    .test-btn-filled {
      -webkit-app-region: no-drag;
      padding: 10px 20px;
      border: none;
      border-radius: 100px;
      background: var(--text-primary);
      color: #fff;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .test-btn-filled:hover {
      background: #000;
    }

    /* Test: Waveform */
    .test-waveform {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .test-waveform canvas {
      display: block;
    }

    /* Test: Large keycap */
    .test-keycap-lg {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .test-keycap-lg kbd {
      min-width: 52px;
      height: 52px;
      font-size: 20px;
      border-radius: var(--radius-md);
      transition: all 0.2s ease;
    }

    .test-keycap-lg.active kbd {
      background: var(--accent-blue);
      color: #fff;
      border-color: var(--accent-blue);
      border-bottom-color: #0062cc;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.35);
    }

    .test-keycap-lg kbd.pressed {
      background: var(--accent-blue);
      color: #fff;
      border-color: var(--accent-blue);
      border-bottom-color: #0062cc;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.35);
    }

    /* Test: Instruction card */
    .test-instruction-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      background: #f0f7ff;
      border-radius: var(--radius-md);
      margin-bottom: 20px;
    }

    .test-instruction-card svg {
      flex-shrink: 0;
    }

    .test-instruction-card span {
      font-size: 13px;
      color: var(--text-primary);
      line-height: 1.4;
    }

    .test-sample-text {
      border-left: 3px solid var(--accent-blue);
      padding: 12px 16px;
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
      font-style: italic;
      margin-bottom: 0;
    }

    /* Test: Gmail-style compose editor */
    .test-gmail-editor {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.10), 0 0 0 1px rgba(0, 0, 0, 0.06);
      width: 100%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .test-gmail-titlebar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 14px;
      background: #404040;
      color: #fff;
    }

    .test-gmail-title {
      font-size: 13px;
      font-weight: 500;
    }

    .test-gmail-close {
      font-size: 18px;
      opacity: 0.6;
      cursor: default;
      line-height: 1;
    }

    .test-gmail-fields {
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    }

    .test-gmail-field {
      display: flex;
      align-items: center;
      padding: 6px 14px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      font-size: 13px;
    }

    .test-gmail-label {
      color: var(--text-tertiary);
      width: 54px;
      flex-shrink: 0;
    }

    .test-gmail-value {
      color: var(--text-primary);
    }

    .test-gmail-body {
      padding: 14px 16px;
      min-height: 120px;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-primary);
      outline: none;
      cursor: text;
      -webkit-user-select: text;
      user-select: text;
    }

    .test-gmail-body:focus {
      background: rgba(0, 122, 255, 0.02);
    }

    .test-gmail-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 14px;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
    }

    .test-gmail-send {
      background: #1a73e8;
      color: #fff;
      font-size: 12px;
      font-weight: 600;
      padding: 6px 18px;
      border-radius: 16px;
      cursor: default;
    }

    .test-gmail-toolbar-icons {
      display: flex;
      gap: 12px;
      font-size: 14px;
      color: var(--text-tertiary);
    }

    .test-plain-editor {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.10), 0 0 0 1px rgba(0, 0, 0, 0.06);
      width: 100%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .test-plain-titlebar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 14px;
      background: var(--bg-sidebar);
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }

    .test-plain-titlebar .test-plain-dots {
      display: flex;
      gap: 6px;
    }

    .test-plain-titlebar .test-plain-dots span {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .test-plain-titlebar .test-plain-dots span:nth-child(1) { background: #ff5f57; }
    .test-plain-titlebar .test-plain-dots span:nth-child(2) { background: #ffbd2e; }
    .test-plain-titlebar .test-plain-dots span:nth-child(3) { background: #28c840; }

    .test-plain-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .test-plain-body {
      padding: 14px 16px;
      min-height: 180px;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-primary);
      outline: none;
      cursor: text;
      -webkit-user-select: text;
      user-select: text;
    }

    .test-plain-body:focus {
      background: rgba(0, 122, 255, 0.02);
    }

    .test-doc-hint {
      font-size: 12px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 12px;
      line-height: 1.4;
    }

    .test-doc-hint .accent {
      color: var(--accent-blue);
      font-weight: 600;
    }

    /* ── Prompt Rules ── */
    .prompt-rules-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border-divider);
    }

    .prompt-rules-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .prompt-rules-header .section-title {
      font-size: 12px;
    }

    .add-rule-btn {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      padding: 4px 12px;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      color: var(--accent-blue);
      font-family: 'Inter', sans-serif;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .add-rule-btn:hover {
      background: var(--bg-sidebar);
      border-color: rgba(0, 0, 0, 0.15);
    }

    .prompt-rules-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .prompt-rules-empty {
      font-size: 12px;
      color: var(--text-tertiary);
      text-align: center;
      padding: 20px 12px;
      background: var(--bg-sidebar);
      border-radius: var(--radius-md);
    }

    .prompt-rule-card {
      background: var(--bg-sidebar);
      border-radius: var(--radius-md);
      transition: opacity 0.15s ease;
    }

    .prompt-rule-card.disabled .prompt-rule-header-name {
      opacity: 0.5;
    }

    .prompt-rule-header {
      display: flex;
      cursor: pointer;
      align-items: center;
      padding: 10px 12px;
      gap: 8px;
      border-radius: var(--radius-md);
      transition: background 0.15s ease;
    }

    .prompt-rule-header:hover {
      background: var(--bg-hover);
    }

    .prompt-rule-icon {
      flex-shrink: 0;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .prompt-rule-icon svg {
      width: 14px;
      height: 14px;
    }

    .prompt-rule-header-name {
      flex: 1;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .prompt-rule-chevron {
      flex-shrink: 0;
      font-size: 10px;
      color: var(--text-tertiary);
      transition: transform 0.2s ease;
    }

    .prompt-rule-card.expanded .prompt-rule-chevron {
      transform: rotate(90deg);
    }

    .prompt-rule-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.2s ease;
    }

    .prompt-rule-card.expanded .prompt-rule-body {
      max-height: 500px;
    }

    .prompt-rule-body-inner {
      padding: 0 12px 12px;
    }

    .prompt-rule-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .prompt-rule-actions {
      display: flex;
      gap: 4px;
      margin-top: 8px;
    }

    .prompt-rule-actions button {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      padding: 2px 6px;
      border: none;
      border-radius: 4px;
      background: transparent;
      color: var(--text-tertiary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .prompt-rule-actions button:hover {
      background: var(--bg-hover);
      color: var(--text-secondary);
    }

    .prompt-rule-match {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .prompt-rule-prompt {
      font-size: 11px;
      color: var(--text-tertiary);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .prompt-rules-desc {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .default-prompt-card {
      background: var(--bg-sidebar);
      border-radius: var(--radius-md);
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .default-prompt-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      background: rgba(59, 130, 246, 0.1);
      color: var(--accent-blue);
      font-size: 11px;
      font-weight: 600;
    }

    .default-prompt-desc {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    /* ── Rule Editor Modal ── */
    .rule-editor-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 2000;
    }

    .rule-editor-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .rule-editor-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }

    .rule-editor-card {
      position: relative;
      width: 420px;
      max-height: 80vh;
      overflow-y: auto;
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 0 0 1px var(--border-subtle);
      animation: confirmFadeIn 0.15s ease;
    }

    .rule-editor-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .rule-editor-field {
      margin-bottom: 14px;
    }

    .rule-editor-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .rule-editor-input,
    .rule-editor-select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s ease;
    }

    .rule-editor-input:focus,
    .rule-editor-select:focus {
      border-color: var(--accent-blue);
    }

    .rule-editor-textarea {
      width: 100%;
      min-height: 80px;
      padding: 8px 10px;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      outline: none;
      resize: vertical;
      transition: border-color 0.15s ease;
    }

    .rule-editor-textarea:focus {
      border-color: var(--accent-blue);
    }

    .rule-editor-hint {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .rule-editor-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 18px;
    }

    .rule-editor-actions button {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      padding: 7px 18px;
      border-radius: var(--radius-sm);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
    }

    .rule-editor-cancel {
      background: var(--bg-hover);
      color: var(--text-secondary);
    }

    .rule-editor-cancel:hover {
      background: var(--bg-active);
      color: var(--text-primary);
    }

    .rule-editor-save {
      background: var(--accent-blue);
      color: #fff;
    }

    .rule-editor-save:hover {
      filter: brightness(1.1);
    }

    /* ── Dictionary ── */

    .dictionary-desc {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .dictionary-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: var(--bg-sidebar);
      border-radius: var(--radius-md);
      margin-bottom: 16px;
    }

    .dictionary-toggle-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .dictionary-toggle-desc {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .dictionary-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .dictionary-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .dictionary-empty {
      font-size: 12px;
      color: var(--text-tertiary);
      text-align: center;
      padding: 20px 12px;
      background: var(--bg-sidebar);
      border-radius: var(--radius-md);
    }

    .dictionary-empty-hint {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .dictionary-card {
      background: var(--bg-sidebar);
      border-radius: var(--radius-md);
      padding: 12px;
      transition: opacity 0.15s ease;
    }

    .dictionary-card.disabled {
      opacity: 0.5;
    }

    .dictionary-card-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .dictionary-card-terms {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .dictionary-card-actions {
      display: flex;
      gap: 4px;
    }

    .dictionary-card-actions button {
      -webkit-app-region: no-drag;
      app-region: no-drag;
      padding: 2px 6px;
      border: none;
      border-radius: 4px;
      background: transparent;
      color: var(--text-tertiary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .dictionary-card-actions button:hover {
      background: var(--bg-hover);
      color: var(--text-secondary);
    }

  </style>
</head>
<body>
  <!-- Setup Overlay (first-launch model download) -->
  <div id="setupOverlay" class="setup-overlay" style="display:none">
    <div class="setup-backdrop"></div>
    <div class="setup-card">

      <!-- Permissions state -->
      <div id="setupPermissions" class="setup-state">
        <div style="margin-bottom: 20px;">
          <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M32 6L8 18V30C8 45.464 18.152 59.68 32 63C45.848 59.68 56 45.464 56 30V18L32 6Z" fill="#007AFF" opacity="0.12"/>
            <path d="M32 8L10 19V30C10 44.36 19.52 57.52 32 60.8C44.48 57.52 54 44.36 54 30V19L32 8Z" stroke="#007AFF" stroke-width="2" fill="none"/>
            <path d="M24 33L30 39L42 27" stroke="#007AFF" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="setup-title" data-i18n="setup.permissionsTitle">Permissions Required</div>
        <div class="setup-desc" data-i18n="setup.permissionsDesc">
          Voxink needs these permissions to record audio and paste text at your cursor.
        </div>
        <div class="setup-permissions-list">
          <div class="setup-permission-row" id="permRowMic">
            <div class="setup-permission-icon">
              <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="6" y="2" width="6" height="9" rx="3" fill="#007AFF"/>
                <path d="M4 8.5C4 11.26 6.24 13.5 9 13.5C11.76 13.5 14 11.26 14 8.5" stroke="#007AFF" stroke-width="1.5" stroke-linecap="round"/>
                <line x1="9" y1="13.5" x2="9" y2="16" stroke="#007AFF" stroke-width="1.5" stroke-linecap="round"/>
                <line x1="6.5" y1="16" x2="11.5" y2="16" stroke="#007AFF" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="setup-permission-info">
              <div class="setup-permission-name" data-i18n="setup.permMicName">Microphone</div>
              <div class="setup-permission-desc" data-i18n="setup.permMicDesc">Record your voice for transcription</div>
            </div>
            <div id="permMicAction">
              <button class="setup-permission-btn" onclick="openPermSettings('microphone')" data-i18n="setup.permGrant">Grant</button>
            </div>
          </div>
          <div class="setup-permission-row" id="permRowAcc">
            <div class="setup-permission-icon">
              <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="9" cy="5" r="2.5" fill="#007AFF"/>
                <path d="M9 8.5C6 8.5 3.5 10 3.5 12.5V14.5C3.5 15.05 3.95 15.5 4.5 15.5H13.5C14.05 15.5 14.5 15.05 14.5 14.5V12.5C14.5 10 12 8.5 9 8.5Z" fill="#007AFF"/>
              </svg>
            </div>
            <div class="setup-permission-info">
              <div class="setup-permission-name" data-i18n="setup.permAccName">Accessibility</div>
              <div class="setup-permission-desc" data-i18n="setup.permAccDesc">Paste text at your cursor with Cmd+V</div>
            </div>
            <div id="permAccAction">
              <button class="setup-permission-btn" onclick="openPermSettings('accessibility')" data-i18n="setup.permGrant">Grant</button>
            </div>
          </div>
        </div>
        <button class="setup-continue-btn" id="permContinueBtn" onclick="permissionsContinue()" disabled data-i18n="setup.permContinue">Continue</button>
      </div>

      <!-- Initial state -->
      <div id="setupInitial" class="setup-state active">
        <div class="setup-mic-wrap">
          <div class="wave"></div>
          <div class="wave"></div>
          <div class="wave"></div>
          <svg class="setup-mic-icon" width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="22" y="8" width="20" height="32" rx="10" fill="#007AFF"/>
            <rect x="16" y="28" width="32" height="2" rx="1" fill="none" stroke="#007AFF" stroke-width="2"/>
            <path d="M16 29C16 38.941 24.059 47 34 47H30C20.059 47 12 38.941 12 29" fill="none"/>
            <path d="M18 30C18 38.284 24.716 45 33 45H31C22.716 45 16 38.284 16 30" fill="none" stroke="#007AFF" stroke-width="2" stroke-linecap="round"/>
            <path d="M46 30C46 38.284 39.284 45 31 45H33C41.284 45 48 38.284 48 30" fill="none" stroke="#007AFF" stroke-width="2" stroke-linecap="round"/>
            <line x1="32" y1="45" x2="32" y2="53" stroke="#007AFF" stroke-width="2" stroke-linecap="round"/>
            <line x1="25" y1="53" x2="39" y2="53" stroke="#007AFF" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="setup-title" data-i18n="setup.initialTitle">Set Up Speech Recognition</div>
        <div class="setup-desc" data-i18n="setup.initialDesc">
          Voxink needs to download a speech recognition model (~1.5 GB) for fully offline transcription. This only happens once.
        </div>
        <button class="setup-download-btn" onclick="startModelDownload()" data-i18n="setup.downloadBtn">Download Model</button>
      </div>

      <!-- Downloading state -->
      <div id="setupDownloading" class="setup-state">
        <div class="setup-mic-wrap">
          <div class="wave"></div>
          <div class="wave"></div>
          <div class="wave"></div>
          <svg class="setup-mic-icon" width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="22" y="8" width="20" height="32" rx="10" fill="#007AFF"/>
            <rect x="16" y="28" width="32" height="2" rx="1" fill="none" stroke="#007AFF" stroke-width="2"/>
            <path d="M18 30C18 38.284 24.716 45 33 45H31C22.716 45 16 38.284 16 30" fill="none" stroke="#007AFF" stroke-width="2" stroke-linecap="round"/>
            <path d="M46 30C46 38.284 39.284 45 31 45H33C41.284 45 48 38.284 48 30" fill="none" stroke="#007AFF" stroke-width="2" stroke-linecap="round"/>
            <line x1="32" y1="45" x2="32" y2="53" stroke="#007AFF" stroke-width="2" stroke-linecap="round"/>
            <line x1="25" y1="53" x2="39" y2="53" stroke="#007AFF" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="setup-title" data-i18n="setup.downloadingTitle">Downloading Model...</div>
        <div class="setup-progress-wrap">
          <div class="setup-progress-track">
            <div class="setup-progress-fill" id="setupProgressFill"></div>
          </div>
          <div class="setup-progress-label">
            <span id="setupProgressPercent">0%</span>
            <span id="setupProgressSize">0 MB / 0 MB</span>
          </div>
        </div>
      </div>

      <!-- Complete state -->
      <div id="setupComplete" class="setup-state">
        <div class="setup-success-icon">
          <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="32" cy="32" r="28" fill="#34C759"/>
            <path d="M20 33L28 41L44 25" stroke="white" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="setup-title" data-i18n="setup.completeTitle">Ready to Go!</div>
        <div class="setup-desc" data-i18n="setup.completeDesc">
          Speech recognition model downloaded successfully. You can start using Voxink now.
        </div>
      </div>

      <!-- Polish choice state -->
      <div id="setupPolishChoice" class="setup-state">
        <div class="setup-mic-wrap">
          <div class="wave"></div>
          <div class="wave"></div>
          <div class="wave"></div>
          <svg class="setup-mic-icon" width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Large sparkle star -->
            <path d="M32 8L35.5 24.5L52 28L35.5 31.5L32 48L28.5 31.5L12 28L28.5 24.5Z" fill="#007AFF"/>
            <!-- Small sparkle star top-right -->
            <path d="M48 10L49.5 15.5L55 17L49.5 18.5L48 24L46.5 18.5L41 17L46.5 15.5Z" fill="#007AFF" opacity="0.7"/>
            <!-- Small sparkle star bottom-right -->
            <path d="M50 38L51 42L55 43L51 44L50 48L49 44L45 43L49 42Z" fill="#007AFF" opacity="0.5"/>
          </svg>
        </div>
        <div class="setup-title" data-i18n="setup.polishChoiceTitle">Set Up AI Polishing</div>
        <div class="setup-desc" data-i18n="setup.polishChoiceDesc">
          Auto-fix grammar and filler words.
        </div>
        <div class="segmented-control setup-polish-mode-control">
          <button class="active" onclick="selectSetupPolishMode('local')" data-i18n="setup.polishLocal">Local</button>
          <button onclick="selectSetupPolishMode('cloud')" data-i18n="setup.polishCloud">Cloud API</button>
        </div>
        <div id="setupPolishLocalPanel" class="setup-polish-panel">
          <div class="setup-polish-panel-desc" data-i18n="setup.polishLocalDesc">Fully offline, ~4.6 GB download. Your data never leaves this device.</div>
          <button class="setup-download-btn" onclick="startSetupLlmDownload()" data-i18n="setup.llmDownloadBtn">Download Model</button>
        </div>
        <div id="setupPolishCloudPanel" class="setup-polish-panel" style="display:none">
          <div class="setup-polish-panel-desc" data-i18n="setup.polishCloudDesc">Faster, but text is sent to an external server. Requires an API key.</div>
          <button class="setup-download-btn" onclick="setupChooseCloud()" data-i18n="setup.polishCloudContinue">Continue</button>
        </div>
        <button class="setup-skip-link" onclick="skipLlmDownload()" data-i18n="setup.polishSkip">Skip for now</button>
      </div>

      <!-- LLM downloading state -->
      <div id="setupLlmDownloading" class="setup-state">
        <div class="setup-mic-wrap">
          <div class="wave"></div>
          <div class="wave"></div>
          <div class="wave"></div>
          <svg class="setup-mic-icon" width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="32" cy="32" r="28" fill="none" stroke="#007AFF" stroke-width="2"/>
            <text x="32" y="40" text-anchor="middle" font-size="28" fill="#007AFF">AI</text>
          </svg>
        </div>
        <div class="setup-title" data-i18n="setup.llmDownloadingTitle">Downloading AI Model...</div>
        <div class="setup-progress-wrap">
          <div class="setup-progress-track">
            <div class="setup-progress-fill" id="setupLlmProgressFill"></div>
          </div>
          <div class="setup-progress-label">
            <span id="setupLlmProgressPercent">0%</span>
            <span id="setupLlmProgressSize">0 MB / 0 MB</span>
          </div>
        </div>
      </div>

      <!-- Error state -->
      <div id="setupError" class="setup-state">
        <div class="setup-error-icon">
          <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="32" cy="32" r="28" fill="#FF3B30"/>
            <path d="M22 22L42 42M42 22L22 42" stroke="white" stroke-width="3.5" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="setup-title" data-i18n="setup.errorTitle">Download Failed</div>
        <div class="setup-error-msg" id="setupErrorMsg" data-i18n="setup.errorDefault">An unexpected error occurred.</div>
        <button class="setup-retry-btn" onclick="startModelDownload()" data-i18n="setup.retryBtn">Retry Download</button>
      </div>

    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-drag"></div>
    <nav class="sidebar-nav">
      <button class="nav-item active" onclick="switchPage('settings')" id="navSettings">
        <span class="nav-icon">&#9881;</span>
        <span data-i18n="nav.settings">Settings</span>
      </button>
      <button class="nav-item" onclick="switchPage('promptRules')" id="navPromptRules">
        <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg></span>
        <span data-i18n="nav.promptRules">Prompt Rules</span>
      </button>
      <button class="nav-item" onclick="switchPage('dictionary')" id="navDictionary">
        <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></span>
        <span data-i18n="nav.dictionary">Dictionary</span>
      </button>
      <button class="nav-item" onclick="switchPage('history')" id="navHistory">
        <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
        <span data-i18n="nav.history">History</span>
      </button>
      <button class="nav-item" onclick="switchPage('test')" id="navTest">
        <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg></span>
        <span data-i18n="nav.test">Test</span>
      </button>
      <button class="nav-item" onclick="switchPage('about')" id="navAbout">
        <span class="nav-icon">&#9432;</span>
        <span data-i18n="nav.about">About</span>
      </button>
    </nav>
    <div class="sidebar-footer">
      <div class="sidebar-version" id="sidebarVersion"></div>
    </div>
  </div>

  <!-- Content Area -->
  <div class="content-area">
    <div class="content-drag"></div>
    <div class="content-scroll">

      <!-- Settings Page -->
      <div class="page active" id="pageSettings">
        <div class="page-title" data-i18n="settings.title">Settings</div>

        <!-- Language Section -->
        <div class="section">
          <div class="section-header">
            <span class="section-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></span>
            <span class="section-title" data-i18n="settings.language">Language</span>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-name" data-i18n="settings.language.label">Interface language</div>
              <div class="setting-desc" data-i18n="settings.language.desc">Choose the display language for the app</div>
            </div>
            <select class="lang-select" id="languageSelect" onchange="onLanguageChange()">
              <option value="en">English</option>
              <option value="zh-TW">繁體中文</option>
            </select>
          </div>
        </div>

        <div class="section-divider"></div>

        <!-- Keyboard Shortcuts Section -->
        <div class="section">
          <div class="section-header">
            <span class="section-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M6 12h.01M10 12h.01M14 12h.01M18 12h.01M8 16h8"/></svg></span>
            <span class="section-title" data-i18n="settings.shortcuts">Keyboard Shortcuts</span>
          </div>
          <div class="hotkey-row" id="hotkeyDisplay">
            <div class="keycaps" id="keycaps"></div>
            <button class="hotkey-btn" id="changeBtn" onclick="startCapture()" data-i18n="settings.shortcuts.change">Change</button>
          </div>
          <div class="hotkey-capture" id="hotkeyCapture">
            <div class="capture-label" data-i18n="settings.shortcuts.captureLabel">Press your new shortcut...</div>
            <div class="capture-preview" id="capturePreview"></div>
            <div class="capture-hint" data-i18n="settings.shortcuts.captureHint">Use at least one modifier (&#8984; &#8997; &#8963; &#8679;) + a key</div>
            <div class="capture-actions">
              <button class="btn-cancel" onclick="cancelCapture()" data-i18n="settings.shortcuts.cancel">Cancel</button>
            </div>
          </div>
        </div>

        <div class="section-divider"></div>

        <!-- Microphone Section -->
        <div class="section">
          <div class="section-header">
            <span class="section-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="2" width="6" height="11" rx="3"/><path d="M5 10a7 7 0 0 0 14 0"/><line x1="12" y1="19" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/></svg></span>
            <span class="section-title" data-i18n="settings.mic">Microphone</span>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-name mic-device" id="micDeviceName">Detecting...</div>
              <div class="setting-desc" id="micDeviceDesc"></div>
            </div>
            <div class="mic-status">
              <span class="mic-dot" id="micDot"></span>
              <select class="mic-select" id="micSelect">
                <option value="auto">Auto</option>
              </select>
            </div>
          </div>
        </div>

        <div class="section-divider"></div>

        <!-- Speech Recognition Section -->
        <div class="section" id="sttCard">
          <div class="section-header">
            <span class="section-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg></span>
            <span class="section-title" data-i18n="settings.stt">Speech Recognition</span>
          </div>
          <!-- Mode selector -->
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-name" data-i18n="settings.stt.mode">Mode</div>
              <div class="setting-desc" data-i18n="settings.stt.modeDesc">Choose local or cloud transcription engine</div>
            </div>
            <div class="segmented-control" id="sttModeControl">
              <button class="active" onclick="selectSttMode('local')" data-i18n="settings.stt.modeLocal">Local</button>
              <button onclick="selectSttMode('cloud')" data-i18n="settings.stt.modeCloud">Cloud API</button>
            </div>
          </div>

          <!-- Local panel: Whisper model download -->
          <div class="sub-settings visible" id="sttLocalPanel">
            <div class="polish-model-card">
              <div class="polish-model-header">
                <div>
                  <div class="polish-model-name">Whisper large-v3-turbo-zh-TW</div>
                  <div class="polish-model-size">~1.5 GB</div>
                </div>
                <button class="polish-download-btn" id="sttModelDownloadBtn" onclick="startSttModelDownload()">Download</button>
              </div>
              <div class="polish-progress-wrap" id="sttModelProgressWrap" style="display:none">
                <div class="polish-progress-track">
                  <div class="polish-progress-fill" id="sttModelProgressFill"></div>
                </div>
                <div class="polish-progress-label">
                  <span id="sttModelProgressPercent">0%</span>
                  <span id="sttModelProgressSize">0 MB / 0 MB</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Cloud panel -->
          <div class="sub-settings" id="sttCloudPanel">
            <div class="cloud-row">
              <div class="setting-info">
                <div class="setting-name sub-name" data-i18n="settings.stt.provider">Provider</div>
              </div>
              <select class="cloud-select" id="sttProviderSelect" onchange="onSttProviderChange()">
                <option value="deepgram">Deepgram</option>
                <option value="groq">Groq</option>
                <option value="open_ai">OpenAI</option>
                <option value="azure">Azure</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div class="cloud-row">
              <div class="setting-info">
                <div class="setting-name sub-name" data-i18n="settings.stt.apiKey">API Key</div>
              </div>
              <div style="display:flex;align-items:center;gap:6px;flex:1;max-width:280px">
                <input type="password" class="cloud-input" id="sttApiKeyInput" placeholder="sk-..." onchange="onSttCloudConfigChange()" style="max-width:none" />
                <button class="provider-link-btn" id="sttProviderLinkBtn" onclick="openSttProviderApiPage()" title="Get API Key" style="display:none">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                </button>
              </div>
            </div>
            <div class="cloud-row" id="sttAzureRegionRow" style="display:none">
              <div class="setting-info">
                <div class="setting-name sub-name" data-i18n="settings.stt.azureRegion">Region</div>
              </div>
              <input type="text" class="cloud-input" id="sttAzureRegionInput" placeholder="eastus" onchange="onSttCloudConfigChange()" />
            </div>
            <div class="cloud-row" id="sttEndpointRow" style="display:none">
              <div class="setting-info">
                <div class="setting-name sub-name" data-i18n="settings.stt.endpoint">Endpoint</div>
              </div>
              <input type="text" class="cloud-input" id="sttEndpointInput" placeholder="https://api.example.com/v1/audio/transcriptions" onchange="onSttCloudConfigChange()" />
            </div>
            <div class="cloud-row" id="sttModelSelectRow">
              <div class="setting-info">
                <div class="setting-name sub-name" data-i18n="settings.stt.cloudModel">Model</div>
              </div>
              <select class="cloud-select" id="sttModelSelect" onchange="onSttModelChange()">
              </select>
            </div>
            <div class="cloud-row" id="sttCustomModelRow" style="display:none">
              <div class="setting-info">
                <div class="setting-name sub-name" data-i18n="settings.stt.modelId">Model ID</div>
              </div>
              <input type="text" class="cloud-input" id="sttCustomModelInput" placeholder="whisper-large-v3-turbo" oninput="onSttCustomModelInput()" onchange="onSttCloudConfigChange()" />
            </div>
            <div class="cloud-row">
              <div class="setting-info">
                <div class="setting-name sub-name" data-i18n="settings.stt.language">Language</div>
              </div>
              <select class="cloud-select" id="sttLanguageSelect" onchange="onSttCloudConfigChange()">
                <option value="zh-TW">繁體中文</option>
                <option value="zh-CN">简体中文</option>
                <option value="en">English</option>
                <option value="ja">日本語</option>
                <option value="ko">한국어</option>
                <option value="">Auto</option>
              </select>
            </div>
          </div>
        </div>

        <div class="section-divider"></div>

        <!-- AI Polishing Section -->
        <div class="section" id="polishCard">
          <div class="section-header">
            <span class="section-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"/><path d="M20 3v4"/><path d="M22 5h-4"/></svg></span>
            <span class="section-title" data-i18n="settings.polish">AI Polishing</span>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-name" data-i18n="settings.polish.toggle">Polish transcription with AI</div>
              <div class="setting-desc" data-i18n="settings.polish.toggleDesc">Refine grammar, tone, and clarity</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="polishToggle" onchange="togglePolish()" />
              <div class="toggle-track"></div>
            </label>
          </div>
          <div class="sub-settings" id="polishSub">
            <!-- Mode selector -->
            <div class="setting-row sub-row">
              <div class="setting-info">
                <div class="setting-name sub-name" data-i18n="settings.polish.mode">Mode</div>
              </div>
              <div class="segmented-control" id="polishModeControl">
                <button class="active" onclick="selectPolishMode('local')" data-i18n="settings.polish.modeLocal">Local</button>
                <button onclick="selectPolishMode('cloud')" data-i18n="settings.polish.modeCloud">Cloud API</button>
              </div>
            </div>

            <!-- Reasoning toggle -->
            <div class="setting-row sub-row">
              <div class="setting-info">
                <div class="setting-name sub-name" data-i18n="settings.polish.reasoning">Enable reasoning</div>
                <div class="setting-desc" data-i18n="settings.polish.reasoningDesc">Allow the model to think step-by-step before responding (slower)</div>
              </div>
              <label class="toggle">
                <input type="checkbox" id="polishReasoningToggle" onchange="onPolishReasoningChange()" />
                <div class="toggle-track"></div>
              </label>
            </div>

            <!-- Local panel -->
            <div class="local-panel visible" id="polishLocalPanel">
              <div class="setting-row sub-row">
                <div class="setting-info">
                  <div class="setting-name sub-name" data-i18n="settings.polish.model">Model</div>
                </div>
                <div class="segmented-control" id="polishModelControl">
                  <button class="active" onclick="selectPolishModel('llama_taiwan')">Llama 3 Taiwan</button>
                  <button onclick="selectPolishModel('qwen25')">Qwen 2.5</button>
                </div>
              </div>
              <div class="polish-model-card" id="polishModelCard">
                <div class="polish-model-header">
                  <div>
                    <div class="polish-model-name" id="polishModelName">Llama 3 Taiwan 8B</div>
                    <div class="polish-model-size" id="polishModelSize">Q4_K_M (~4.6 GB)</div>
                  </div>
                  <button class="polish-download-btn" id="polishDownloadBtn" onclick="startLlmModelDownload()">Download</button>
                </div>
                <div class="polish-progress-wrap" id="polishProgressWrap" style="display:none">
                  <div class="polish-progress-track">
                    <div class="polish-progress-fill" id="polishProgressFill"></div>
                  </div>
                  <div class="polish-progress-label">
                    <span id="polishProgressPercent">0%</span>
                    <span id="polishProgressSize">0 MB / 0 MB</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cloud panel -->
            <div class="cloud-panel" id="polishCloudPanel">
              <div class="cloud-row">
                <div class="setting-info">
                  <div class="setting-name sub-name" data-i18n="settings.polish.provider">Provider</div>
                </div>
                <select class="cloud-select" id="cloudProviderSelect" onchange="onProviderChange()">
                  <option value="groq">Groq</option>
                  <option value="open_router">OpenRouter</option>
                  <option value="open_ai">OpenAI</option>
                  <option value="gemini">Gemini</option>
                  <option value="samba_nova">SambaNova</option>
                  <option value="custom">Custom</option>
                </select>
              </div>
              <div class="cloud-row">
                <div class="setting-info">
                  <div class="setting-name sub-name" data-i18n="settings.polish.apiKey">API Key</div>
                </div>
                <div style="display:flex;align-items:center;gap:6px;flex:1;max-width:280px">
                  <input type="password" class="cloud-input" id="cloudApiKeyInput" placeholder="sk-..." onchange="onCloudConfigChange()" style="max-width:none" />
                  <button class="provider-link-btn" id="providerLinkBtn" onclick="openProviderApiPage()" title="Get API Key" style="display:none">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                  </button>
                </div>
              </div>
              <div class="cloud-row" id="cloudEndpointRow" style="display:none">
                <div class="setting-info">
                  <div class="setting-name sub-name" data-i18n="settings.polish.endpoint">Endpoint</div>
                </div>
                <input type="text" class="cloud-input" id="cloudEndpointInput" placeholder="https://api.example.com/v1/chat/completions" onchange="onCloudConfigChange()" />
              </div>
              <div class="cloud-row" id="cloudModelSelectRow">
                <div class="setting-info">
                  <div class="setting-name sub-name" data-i18n="settings.polish.cloudModel">Model</div>
                </div>
                <select class="cloud-select" id="cloudModelSelect" onchange="onCloudModelChange()">
                </select>
              </div>
              <div class="cloud-row" id="cloudCustomModelRow" style="display:none">
                <div class="setting-info">
                  <div class="setting-name sub-name" data-i18n="settings.polish.modelId">Model ID</div>
                </div>
                <input type="text" class="cloud-input" id="cloudCustomModelInput" placeholder="google/gemma-3n-e2b-it:free" oninput="onCustomModelInput()" onchange="onCloudConfigChange()" />
              </div>
            </div>

            <!-- Output language (always visible) -->
            <div class="setting-row sub-row">
              <div class="setting-info">
                <div class="setting-name sub-name" data-i18n="settings.polish.outputLang">Output language</div>
              </div>
              <select class="lang-select" id="polishLangSelect" onchange="savePolishSettings()">
                <option value="traditional_chinese">&#32321;&#39636;&#20013;&#25991;</option>
                <option value="simplified_chinese">&#31616;&#20307;&#20013;&#25991;</option>
                <option value="english">English</option>
                <option value="japanese">&#26085;&#26412;&#35486;</option>
                <option value="korean">&#54620;&#44397;&#50612;</option>
                <option value="auto">Auto</option>
              </select>
            </div>

          </div>
        </div>

        <div class="section-divider"></div>

        <!-- Reset Section -->
        <div class="section">
          <div class="section-header">
            <span class="section-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span>
            <span class="section-title" data-i18n="settings.danger">Danger Zone</span>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-name" data-i18n="settings.danger.reset">Reset to Defaults</div>
              <div class="setting-desc" data-i18n="settings.danger.resetDesc">Restore all settings to their original values</div>
            </div>
            <button class="reset-btn" onclick="resetSettings()" data-i18n="settings.danger.resetBtn">Reset</button>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-name" data-i18n="settings.danger.rerunSetup">Re-run Setup</div>
              <div class="setting-desc" data-i18n="settings.danger.rerunSetupDesc">Show the first-launch setup overlay again</div>
            </div>
            <button class="reset-btn" onclick="showSetupWithPermCheck()" data-i18n="settings.danger.rerunSetupBtn">Run Setup</button>
          </div>
        </div>
      </div>

      <!-- Prompt Rules Page -->
      <div class="page" id="pagePromptRules">
        <div class="page-title" data-i18n="promptRules.title">Prompt Rules</div>
        <div class="prompt-rules-desc" data-i18n="promptRules.desc">Rules are matched by the frontmost app — the first matching rule's instructions are appended to the base prompt.</div>
        <div class="prompt-rules-header">
          <span></span>
          <button class="add-rule-btn" onclick="openRuleEditor(-1)" data-i18n="settings.polish.addRule">+ Add Rule</button>
        </div>
        <div id="defaultPromptCard">
          <!-- rendered dynamically by renderPromptRules() -->
        </div>
        <div class="prompt-rules-list" id="promptRulesList">
          <!-- rendered dynamically -->
        </div>
      </div>

      <!-- Dictionary Page -->
      <div class="page" id="pageDictionary">
        <div class="page-title" data-i18n="dictionary.title">Custom Dictionary</div>
        <div class="dictionary-desc" data-i18n="dictionary.desc">Define custom terms so the AI can intelligently replace homophones and similar-sounding words during polishing.</div>
        <div class="dictionary-toggle-row">
          <div>
            <div class="dictionary-toggle-label" data-i18n="dictionary.toggle">Enable custom dictionary</div>
            <div class="dictionary-toggle-desc" data-i18n="dictionary.toggleDesc">Inject dictionary terms into the AI polishing prompt</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="dictToggle" onchange="toggleDictionary()" checked />
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="dictionary-header">
          <span></span>
          <button class="add-rule-btn" onclick="openDictEditor(-1)" data-i18n="dictionary.addEntry">+ Add Entry</button>
        </div>
        <div class="dictionary-list" id="dictionaryList">
          <!-- rendered dynamically -->
        </div>
      </div>

      <!-- History Page -->
      <div class="page" id="pageHistory">
        <div class="page-title" data-i18n="history.title">History</div>
        <div class="history-privacy-card">
          <span class="history-privacy-icon">&#128274;</span>
          <span class="history-privacy-text" data-i18n="history.privacyNote">Your data stays private &mdash; all history is stored locally on this device only.</span>
        </div>
        <div class="history-settings">
          <div class="history-setting-row">
            <div>
              <div class="history-setting-label" data-i18n="history.retention">Data retention</div>
              <div class="history-setting-desc" data-i18n="history.retentionDesc">How long to keep history entries</div>
            </div>
            <select class="history-select" id="historyRetentionSelect" onchange="onRetentionChange()">
              <option value="0" data-i18n="history.retentionForever">Forever</option>
              <option value="7" data-i18n="history.retention7">7 days</option>
              <option value="30" data-i18n="history.retention30">30 days</option>
              <option value="90" data-i18n="history.retention90">90 days</option>
              <option value="180" data-i18n="history.retention180">180 days</option>
              <option value="365" data-i18n="history.retention365">1 year</option>
            </select>
          </div>
          <div class="history-setting-row">
            <div>
              <div class="history-setting-label" data-i18n="history.storageLoc">Storage location</div>
              <div class="history-setting-desc" data-i18n="history.storageLocDesc">Where history and audio files are saved</div>
            </div>
            <div class="history-storage-path" id="historyStoragePath" title="Click to reveal in Finder" onclick="revealStoragePath()">-</div>
          </div>
          <div class="history-setting-row">
            <div>
              <div class="history-setting-label" data-i18n="history.clearAll">Delete All History</div>
              <div class="history-setting-desc" data-i18n="history.clearAllDesc">Permanently delete all history entries and audio files</div>
            </div>
            <button class="reset-btn" onclick="clearAllHistory()" data-i18n="history.clearAll">Delete All History</button>
          </div>
        </div>
        <div class="history-divider"></div>
        <div id="historyList"></div>
      </div>

      <!-- About Page -->
      <div class="page" id="pageAbout">
        <div class="page-title" data-i18n="about.title">About</div>
        <div class="about-content">
          <div class="about-icon"><img src="icon.png" alt="Voxink"></div>
          <div class="about-name">Voxink</div>
          <div class="about-version" data-i18n="about.version">Version 0.1.0</div>
          <div class="about-desc" data-i18n="about.desc">
            Privacy-first, fully offline speech-to-text for macOS.
            Press a hotkey to record, release to transcribe and paste at your cursor.
          </div>
          <div class="about-engine" id="aboutEngine" data-i18n="about.engine">Engine: Whisper &middot; Fully on-device</div>
          <div class="about-update" id="aboutUpdate">
            <button class="about-update-btn" id="updateBtn" onclick="checkForUpdates()" data-i18n="about.checkUpdate">Check for Updates</button>
            <div class="about-update-status" id="updateStatus" style="display:none"></div>
            <div class="about-update-progress" id="updateProgress" style="display:none">
              <div class="about-update-progress-bar" id="updateProgressBar"></div>
            </div>
            <div class="about-update-note" id="updateNote" style="display:none"></div>
          </div>
        </div>
      </div>

      <!-- Test Wizard Page -->
      <div class="page" id="pageTest">
        <div class="test-page">
          <!-- Breadcrumb -->
          <div class="test-breadcrumb">
            <span class="test-breadcrumb-item active" id="testBc1" data-i18n="test.breadcrumb.mic">Microphone</span>
            <span class="test-breadcrumb-sep">&rsaquo;</span>
            <span class="test-breadcrumb-item" id="testBc2" data-i18n="test.breadcrumb.hotkey">Hotkey</span>
            <span class="test-breadcrumb-sep">&rsaquo;</span>
            <span class="test-breadcrumb-item" id="testBc3" data-i18n="test.breadcrumb.general">General</span>
            <span class="test-breadcrumb-sep">&rsaquo;</span>
            <span class="test-breadcrumb-item" id="testBc4" data-i18n="test.breadcrumb.gmail">Gmail</span>
          </div>
          <div class="test-progress-bar">
            <div class="test-progress-fill" id="testProgressFill" style="width: 25%"></div>
          </div>

          <!-- Step 1: Microphone Test -->
          <div class="test-step active" id="testStep1">
            <div class="test-layout">
              <div class="test-left">
                <button class="test-back" onclick="testGoBack(1)" data-i18n="test.backSettings">&larr; Back to Settings</button>
                <div class="test-left-spacer"></div>
                <div class="test-title" data-i18n="test.step1.title">Test your microphone</div>
                <div class="test-subtitle" data-i18n="test.step1.subtitle">Speak normally to see if it's working.</div>
                <div class="test-question" data-i18n="test.step1.question">Do you see the blue bars moving?</div>
                <div class="test-actions">
                  <button class="test-btn-outline" onclick="switchPage('settings')" data-i18n="test.step1.no">No, change mic</button>
                  <button class="test-btn-filled" onclick="goToTestStep(2)" data-i18n="test.step1.yes">Yes, continue</button>
                </div>
                <div class="test-left-spacer"></div>
              </div>
              <div class="test-right">
                <div class="test-waveform">
                  <canvas id="testMicCanvas" width="220" height="140"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Hotkey Test -->
          <div class="test-step" id="testStep2">
            <div class="test-layout">
              <div class="test-left">
                <button class="test-back" onclick="testGoBack(2)" data-i18n="test.back">&larr; Back</button>
                <div class="test-left-spacer"></div>
                <div class="test-title" data-i18n="test.step2.title">Test your hotkey</div>
                <div class="test-subtitle" id="testHotkeySubtitle">Press your hotkey to verify it works.</div>
                <div class="test-question" data-i18n="test.step2.question">Do the keys turn blue when pressed?</div>
                <div class="test-actions">
                  <button class="test-btn-outline" onclick="switchPage('settings')" data-i18n="test.step2.no">No, change hotkey</button>
                  <button class="test-btn-filled" onclick="goToTestStep(3)" data-i18n="test.step2.yes">Yes, continue</button>
                </div>
                <div class="test-left-spacer"></div>
              </div>
              <div class="test-right">
                <div class="test-keycap-lg" id="testHotkeyKeycaps"></div>
              </div>
            </div>
          </div>

          <!-- Step 3: General (no app context) -->
          <div class="test-step" id="testStep3">
            <div class="test-layout">
              <div class="test-left">
                <button class="test-back" onclick="testGoBack(3)" data-i18n="test.back">&larr; Back</button>
                <div class="test-left-spacer"></div>
                <div class="test-title" data-i18n="test.step3.title">General dictation</div>
                <div class="test-instruction-card">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="2" width="6" height="11" rx="3"/><path d="M5 10a7 7 0 0 0 14 0"/><line x1="12" y1="19" x2="12" y2="22"/></svg>
                  <span id="testGeneralInstruction">Click the text area, press the hotkey to start, speak, then press it again to stop</span>
                </div>
                <div class="test-sample-text" data-i18n="test.step3.sampleText">
                  Remind me to buy milk and eggs on the way home today.
                </div>
                <div class="test-left-spacer"></div>
                <div class="test-actions">
                  <button class="test-btn-filled" onclick="goToTestStep(4)" data-i18n="test.step3.next">Next</button>
                </div>
              </div>
              <div class="test-right">
                <div style="display:flex; flex-direction:column; align-items:center; width:92%; max-width:420px;">
                  <div class="test-plain-editor">
                    <div class="test-plain-titlebar">
                      <div class="test-plain-dots"><span></span><span></span><span></span></div>
                      <span class="test-plain-title" data-i18n="test.step3.editorTitle">Untitled</span>
                      <span style="width:38px"></span>
                    </div>
                    <div class="test-plain-body" id="testPlainBody" contenteditable="true" spellcheck="false"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 4: Gmail scenario -->
          <div class="test-step" id="testStep4">
            <div class="test-layout">
              <div class="test-left">
                <button class="test-back" onclick="testGoBack(4)" data-i18n="test.back">&larr; Back</button>
                <div class="test-left-spacer"></div>
                <div class="test-title" data-i18n="test.step4.title">Try it in Gmail!</div>
                <div class="test-instruction-card">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="2" width="6" height="11" rx="3"/><path d="M5 10a7 7 0 0 0 14 0"/><line x1="12" y1="19" x2="12" y2="22"/></svg>
                  <span id="testTryInstruction">Click the email body, press the hotkey to start, speak, then press it again to stop</span>
                </div>
                <div class="test-sample-text" data-i18n="test.step4.sampleText">
                  Try saying: &ldquo;嗨 Alice，我們明天還是照原計劃吃午餐嗎？Alan&rdquo;
                </div>
                <div class="test-left-spacer"></div>
                <div class="test-actions">
                  <button class="test-btn-filled" onclick="switchPage('settings')" data-i18n="test.step4.done">Done</button>
                </div>
              </div>
              <div class="test-right">
                <div style="display:flex; flex-direction:column; align-items:center; width:92%; max-width:420px;">
                  <div class="test-gmail-editor">
                    <div class="test-gmail-titlebar">
                      <span class="test-gmail-title">New Message</span>
                      <span class="test-gmail-close">&times;</span>
                    </div>
                    <div class="test-gmail-fields">
                      <div class="test-gmail-field"><span class="test-gmail-label">To</span><span class="test-gmail-value">alice@example.com</span></div>
                      <div class="test-gmail-field"><span class="test-gmail-label">Subject</span><span class="test-gmail-value">Lunch tomorrow</span></div>
                    </div>
                    <div class="test-gmail-body" id="testGmailBody" contenteditable="true" spellcheck="false"></div>
                    <div class="test-gmail-toolbar">
                      <span class="test-gmail-send">Send</span>
                      <span class="test-gmail-toolbar-icons">
                        <span title="Formatting">A</span>
                        <span title="Attach">&#128206;</span>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Confirm Modal -->
  <!-- History Detail Modal -->
  <div class="history-detail-overlay" id="historyDetailOverlay">
    <div class="confirm-backdrop" onclick="closeHistoryDetail()"></div>
    <div class="history-detail-card">
      <div class="history-detail-title" data-i18n="history.detailTitle">Transcription Detail</div>
      <div class="history-detail-section">
        <div class="history-detail-label" data-i18n="history.before">Before (raw)</div>
        <div class="history-detail-text" id="historyDetailRaw"></div>
      </div>
      <div class="history-detail-section">
        <div class="history-detail-label" data-i18n="history.after">After (polished)</div>
        <div class="history-detail-text" id="historyDetailPolished"></div>
      </div>
      <div class="history-detail-actions">
        <button onclick="closeHistoryDetail()" data-i18n="history.close">Close</button>
      </div>
    </div>
  </div>

  <div class="confirm-overlay" id="confirmOverlay">
    <div class="confirm-backdrop" onclick="closeConfirm()"></div>
    <div class="confirm-card">
      <div class="confirm-title" id="confirmTitle"></div>
      <div class="confirm-message" id="confirmMessage"></div>
      <div class="confirm-actions">
        <button class="confirm-cancel" onclick="closeConfirm()" data-i18n="confirm.cancel">Cancel</button>
        <button class="confirm-destructive" id="confirmOkBtn" data-i18n="confirm.reset">Reset</button>
      </div>
    </div>
  </div>

  <!-- Rule Editor Modal -->
  <div class="rule-editor-overlay" id="ruleEditorOverlay">
    <div class="rule-editor-backdrop" onclick="closeRuleEditor()"></div>
    <div class="rule-editor-card">
      <div class="rule-editor-title" id="ruleEditorTitle" data-i18n="settings.polish.addRule">+ Add Rule</div>
      <div class="rule-editor-field">
        <div class="rule-editor-label" data-i18n="settings.polish.ruleName">Name</div>
        <input type="text" class="rule-editor-input" id="ruleNameInput" data-i18n-placeholder="settings.polish.ruleNamePlaceholder" placeholder="e.g. Slack — casual tone" />
      </div>
      <div class="rule-editor-field">
        <div class="rule-editor-label" data-i18n="settings.polish.ruleMatchType">Match type</div>
        <select class="rule-editor-select" id="ruleMatchTypeSelect">
          <option value="app_name" data-i18n="settings.polish.matchAppName">App Name</option>
          <option value="bundle_id" data-i18n="settings.polish.matchBundleId">Bundle ID</option>
          <option value="url" data-i18n="settings.polish.matchUrl">URL</option>
        </select>
      </div>
      <div class="rule-editor-field">
        <div class="rule-editor-label" data-i18n="settings.polish.ruleMatchValue">Match value</div>
        <input type="text" class="rule-editor-input" id="ruleMatchValueInput" data-i18n-placeholder="settings.polish.ruleMatchValuePlaceholder" placeholder="e.g. Slack, com.tinyspeck.slackmacgap, github.com" />
      </div>
      <div class="rule-editor-field">
        <div class="rule-editor-label" data-i18n="settings.polish.rulePrompt">App-specific instructions</div>
        <textarea class="rule-editor-textarea" id="rulePromptInput" data-i18n-placeholder="settings.polish.rulePromptPlaceholder" placeholder="e.g. Format as email with greeting and sign-off. Use professional tone."></textarea>
        <div class="rule-editor-hint" data-i18n="settings.polish.rulePromptHint">These instructions are appended to the base prompt when this rule matches.</div>
      </div>
      <div class="rule-editor-actions">
        <button class="rule-editor-cancel" onclick="closeRuleEditor()" data-i18n="settings.polish.ruleCancel">Cancel</button>
        <button class="rule-editor-save" onclick="saveRuleEditor()" data-i18n="settings.polish.ruleSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Dictionary Entry Editor Modal -->
  <div class="rule-editor-overlay" id="dictEditorOverlay">
    <div class="rule-editor-backdrop" onclick="closeDictEditor()"></div>
    <div class="rule-editor-card">
      <div class="rule-editor-title" id="dictEditorTitle" data-i18n="dictionary.addEntry">+ Add Term</div>
      <div class="rule-editor-field">
        <div class="rule-editor-label" data-i18n="dictionary.term">Term</div>
        <input type="text" class="rule-editor-input" id="dictTermInput" data-i18n-placeholder="dictionary.termPlaceholder" placeholder="e.g. Jay Chou, TSMC, Kubernetes" />
      </div>
      <div class="rule-editor-actions">
        <button class="rule-editor-cancel" onclick="closeDictEditor()" data-i18n="dictionary.cancel">Cancel</button>
        <button class="rule-editor-save" onclick="saveDictEditor()" data-i18n="dictionary.save">Save</button>
      </div>
    </div>
  </div>

  <script src="i18n.js"></script>
  <script>
    const { invoke } = window.__TAURI__.core;
    const APP_VERSION = window.__TAURI__.app ? window.__TAURI__.app.getVersion() : Promise.resolve('0.0.0');

    let currentHotkey = '';
    let isCapturing = false;
    let capturedKeys = { modifiers: new Set(), code: '' };
    let polishConfig = {
      enabled: false,
      model: 'llama_taiwan',
      output_language: 'traditional_chinese',
      mode: 'local',
      cloud: { provider: 'groq', api_key: '', endpoint: '', model_id: 'qwen/qwen3-32b' },
      prompt_rules: {},
      dictionary: { enabled: true, entries: [] },
    };
    let editingRuleIndex = -1;
    let editingDictIndex = -1;

    /** Get prompt rules for the current output language. */
    function getCurrentRules() {
      const lang = polishConfig.output_language;
      return polishConfig.prompt_rules[lang] || [];
    }

    /** Set prompt rules for the current output language. */
    function setCurrentRules(rules) {
      const lang = polishConfig.output_language;
      polishConfig.prompt_rules[lang] = rules;
    }

    const CLOUD_PROVIDERS = {
      groq: {
        models: [
          { id: 'qwen/qwen3-32b', name: 'Qwen 3 32B' },
          { id: 'openai/gpt-oss-120b', name: 'GPT-oss 120B' },
          { id: 'llama-3.3-70b-versatile', name: 'Llama 3.3 70B' },
        ],
        apiKeyUrl: 'https://console.groq.com/keys',
      },
      open_router: {
        models: [],
        apiKeyUrl: 'https://openrouter.ai/settings/keys',
      },
      open_ai: {
        models: [],
        apiKeyUrl: 'https://platform.openai.com/api-keys',
      },
      gemini: {
        models: [],
        apiKeyUrl: 'https://aistudio.google.com/apikey',
      },
      samba_nova: {
        models: [
          { id: 'Qwen3-32B', name: 'Qwen 3 32B' },
          { id: 'DeepSeek-V3.1', name: 'DeepSeek V3.1' },
          { id: 'Meta-Llama-3.3-70B-Instruct', name: 'Llama 3.3 70B' },
          { id: 'Llama-4-Maverick-17B-128E-Instruct', name: 'Llama 4 Maverick' },
          { id: 'DeepSeek-R1-0528', name: 'DeepSeek R1' },
        ],
        apiKeyUrl: 'https://cloud.sambanova.ai/apis',
      },
      custom: {
        models: [],
      },
    };
    let llmDownloadUnlisten = null;
    let llmDownloadingModel = null;

    // ── STT Cloud Config ──
    const STT_CLOUD_PROVIDERS = {
      deepgram: {
        models: [
          { id: 'whisper', name: 'Whisper' },
        ],
        apiKeyUrl: 'https://console.deepgram.com/api-keys',
      },
      groq: {
        models: [
          { id: 'whisper-large-v3-turbo', name: 'Whisper Large v3 Turbo' },
          { id: 'distil-whisper-large-v3-en', name: 'Distil Whisper Large v3 (EN)' },
        ],
        apiKeyUrl: 'https://console.groq.com/keys',
      },
      open_ai: {
        models: [
          { id: 'whisper-1', name: 'Whisper 1' },
          { id: 'gpt-4o-transcribe', name: 'GPT-4o Transcribe' },
          { id: 'gpt-4o-mini-transcribe', name: 'GPT-4o Mini Transcribe' },
        ],
        apiKeyUrl: 'https://platform.openai.com/api-keys',
      },
      azure: {
        models: [],
        apiKeyUrl: 'https://portal.azure.com/#view/Microsoft_Azure_ProjectOxford/CognitiveServicesHub/~/SpeechServices',
      },
      custom: {
        models: [],
      },
    };
    let sttConfig = { mode: 'local', cloud: { provider: 'deepgram', api_key: '', endpoint: '', model_id: 'whisper', language: 'zh-TW' } };
    let sttModelDownloadUnlisten = null;

    // ── Page navigation ──

    function switchPage(pageId) {
      // Clean up test wizard when leaving
      const currentTestPage = document.getElementById('pageTest');
      if (currentTestPage && currentTestPage.classList.contains('active') && pageId !== 'test') {
        cleanupTestWizard();
      }

      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

      document.getElementById('page' + pageId.charAt(0).toUpperCase() + pageId.slice(1)).classList.add('active');

      if (pageId === 'settings') {
        document.getElementById('navSettings').classList.add('active');
      } else if (pageId === 'promptRules') {
        document.getElementById('navPromptRules').classList.add('active');
        renderPromptRules();
      } else if (pageId === 'dictionary') {
        document.getElementById('navDictionary').classList.add('active');
        renderDictionary();
      } else if (pageId === 'history') {
        document.getElementById('navHistory').classList.add('active');
        loadHistorySettings();
        loadHistory();
      } else if (pageId === 'about') {
        document.getElementById('navAbout').classList.add('active');
      } else if (pageId === 'test') {
        document.getElementById('navTest').classList.add('active');
        startTestWizard();
      }
    }

    // ── Hotkey → display label mapping ──

    const modifierSymbols = {
      'Alt': '\u2325',
      'Control': '\u2303',
      'Shift': '\u21E7',
      'Super': '\u2318',
    };

    const keyLabels = {
      'Space': 'Space',
      'Enter': 'Enter',
      'Tab': 'Tab',
      'Backspace': '\u232B',
      'Delete': '\u2326',
      'Escape': 'Esc',
      'ArrowUp': '\u2191',
      'ArrowDown': '\u2193',
      'ArrowLeft': '\u2190',
      'ArrowRight': '\u2192',
      'Minus': '\u2212',
      'Equal': '=',
      'BracketLeft': '[',
      'BracketRight': ']',
      'Backslash': '\\',
      'Semicolon': ';',
      'Quote': "'",
      'Comma': ',',
      'Period': '.',
      'Slash': '/',
      'Backquote': '`',
    };

    function keyCodeToLabel(code) {
      if (code.startsWith('Key')) return code.slice(3);
      if (code.startsWith('Digit')) return code.slice(5);
      if (code.startsWith('F') && !isNaN(code.slice(1))) return code;
      return keyLabels[code] || code;
    }

    function renderKeycaps(container, hotkeyStr) {
      container.innerHTML = '';
      const parts = hotkeyStr.split('+');
      parts.forEach((part, i) => {
        const kbd = document.createElement('kbd');
        const sym = modifierSymbols[part];
        if (sym) {
          kbd.textContent = sym;
        } else {
          kbd.textContent = keyCodeToLabel(part);
          kbd.classList.add('accent');
        }
        container.appendChild(kbd);
      });
    }

    // ── Load settings on init ──

    async function loadSettings() {
      try {
        const settings = await invoke('get_settings');
        currentHotkey = settings.hotkey;
        renderKeycaps(document.getElementById('keycaps'), currentHotkey);

        // Polish settings
        const polish = settings.polish || {};
        polishConfig.enabled = polish.enabled || false;
        polishConfig.model = polish.model || 'llama_taiwan';
        polishConfig.output_language = polish.output_language || 'traditional_chinese';
        polishConfig.mode = polish.mode || 'local';
        polishConfig.reasoning = polish.reasoning || false;
        // prompt_rules is a per-language map; handle old array format for backwards compat
        const rawRules = polish.prompt_rules;
        if (Array.isArray(rawRules)) {
          polishConfig.prompt_rules = { [polishConfig.output_language]: rawRules };
        } else {
          polishConfig.prompt_rules = rawRules || {};
        }
        const dict = polish.dictionary || {};
        polishConfig.dictionary = {
          enabled: dict.enabled !== false,
          entries: dict.entries || [],
        };

        // Cloud config
        const cloud = polish.cloud || {};
        polishConfig.cloud = {
          provider: cloud.provider || 'groq',
          api_key: '',
          endpoint: cloud.endpoint || '',
          model_id: cloud.model_id || 'qwen/qwen3-32b',
        };

        document.getElementById('polishToggle').checked = polishConfig.enabled;
        document.getElementById('polishReasoningToggle').checked = polishConfig.reasoning;
        document.getElementById('polishLangSelect').value = polishConfig.output_language;

        // Populate cloud UI
        document.getElementById('cloudProviderSelect').value = polishConfig.cloud.provider;
        document.getElementById('cloudEndpointInput').value = polishConfig.cloud.endpoint;
        populateCloudModels();

        // Load API key from keychain for the active provider
        try {
          const key = await invoke('get_api_key', { provider: polishConfig.cloud.provider });
          polishConfig.cloud.api_key = key;
          document.getElementById('cloudApiKeyInput').value = key;
        } catch (e) {
          console.warn('Failed to load API key from keychain:', e);
          document.getElementById('cloudApiKeyInput').value = '';
        }

        // STT settings
        const stt = settings.stt || {};
        sttConfig.mode = stt.mode || 'local';
        const sttCloud = stt.cloud || {};
        sttConfig.cloud = {
          provider: sttCloud.provider || 'deepgram',
          api_key: '',
          endpoint: sttCloud.endpoint || '',
          model_id: sttCloud.model_id || 'whisper',
          language: sttCloud.language !== undefined ? sttCloud.language : 'zh-TW',
        };

        document.getElementById('sttProviderSelect').value = sttConfig.cloud.provider;
        document.getElementById('sttLanguageSelect').value = sttConfig.cloud.language;
        document.getElementById('sttEndpointInput').value = sttConfig.cloud.endpoint;
        document.getElementById('sttAzureRegionInput').value = sttConfig.cloud.endpoint;
        populateSttModels();

        // Load STT API key from keychain
        try {
          const sttKey = await invoke('get_api_key', { provider: 'stt_' + sttConfig.cloud.provider });
          sttConfig.cloud.api_key = sttKey;
          document.getElementById('sttApiKeyInput').value = sttKey;
        } catch (e) {
          console.warn('Failed to load STT API key from keychain:', e);
          document.getElementById('sttApiKeyInput').value = '';
        }

        // i18n: initialize language from settings or auto-detect
        const savedLang = settings.language || null;
        await I18n.initI18n(savedLang);
        localStorage.setItem('voxink-lang', I18n.getLocale());
        document.getElementById('languageSelect').value = I18n.getLocale();

        // Apply version from Tauri API
        const appVer = await APP_VERSION;
        const versionEl = document.querySelector('[data-i18n="about.version"]');
        if (versionEl) versionEl.textContent = t('about.version', { version: appVer });
        document.getElementById('sidebarVersion').textContent = 'v' + appVer;

        updatePolishUI();
        updateSttUI();
        checkSttModelStatus();
        renderPromptRules();
        checkLlmModelStatus();
      } catch (e) {
        console.error('Failed to load settings:', e);
      }
    }

    async function onLanguageChange() {
      const lang = document.getElementById('languageSelect').value;
      await I18n.setLocale(lang);
      localStorage.setItem('voxink-lang', lang);

      // Apply version param after locale change
      const appVer2 = await APP_VERSION;
      const versionEl = document.querySelector('[data-i18n="about.version"]');
      if (versionEl) versionEl.textContent = t('about.version', { version: appVer2 });

      // Persist to settings
      try {
        const settings = await invoke('get_settings');
        settings.language = lang;
        await invoke('save_settings', { newSettings: settings });
      } catch (e) {
        console.error('Failed to save language setting:', e);
      }

      // Re-render dynamic content that's currently visible
      loadMicStatus();
    }

    // ── Hotkey capture ──

    function startCapture() {
      isCapturing = true;
      capturedKeys = { modifiers: new Set(), code: '' };
      document.getElementById('hotkeyDisplay').classList.add('hidden');
      document.getElementById('hotkeyCapture').classList.add('active');
      document.getElementById('capturePreview').innerHTML = '';
      document.addEventListener('keydown', onCaptureKeydown);
      document.addEventListener('keyup', onCaptureKeyup);
    }

    function cancelCapture() {
      isCapturing = false;
      document.getElementById('hotkeyDisplay').classList.remove('hidden');
      document.getElementById('hotkeyCapture').classList.remove('active');
      document.removeEventListener('keydown', onCaptureKeydown);
      document.removeEventListener('keyup', onCaptureKeyup);
    }

    function onCaptureKeydown(e) {
      e.preventDefault();
      e.stopPropagation();

      // Escape cancels
      if (e.key === 'Escape') {
        cancelCapture();
        return;
      }

      // Collect modifiers
      capturedKeys.modifiers = new Set();
      if (e.altKey) capturedKeys.modifiers.add('Alt');
      if (e.ctrlKey) capturedKeys.modifiers.add('Control');
      if (e.shiftKey) capturedKeys.modifiers.add('Shift');
      if (e.metaKey) capturedKeys.modifiers.add('Super');

      // Check if a non-modifier key was pressed
      const nonModifiers = ['Alt', 'Control', 'Shift', 'Meta'];
      if (!nonModifiers.includes(e.key)) {
        capturedKeys.code = e.code; // e.g. "KeyR", "Space", "F1"
      }

      // Render preview
      renderCapturePreview();

      // If we have a key code, auto-confirm (modifiers are optional)
      if (capturedKeys.code) {
        confirmCapture();
      }
    }

    function onCaptureKeyup(e) {
      // If only modifiers were held and released without a key, just update preview
      // (don't auto-confirm, user needs to press a non-modifier key)
    }

    function renderCapturePreview() {
      const preview = document.getElementById('capturePreview');
      preview.innerHTML = '';
      for (const mod of ['Control', 'Alt', 'Shift', 'Super']) {
        if (capturedKeys.modifiers.has(mod)) {
          const kbd = document.createElement('kbd');
          kbd.textContent = modifierSymbols[mod];
          preview.appendChild(kbd);
        }
      }
      if (capturedKeys.code) {
        const kbd = document.createElement('kbd');
        kbd.textContent = keyCodeToLabel(capturedKeys.code);
        kbd.classList.add('accent');
        preview.appendChild(kbd);
      }
    }

    async function confirmCapture() {
      // Build hotkey string: "Alt+Super+KeyR"
      const parts = [];
      for (const mod of ['Control', 'Alt', 'Shift', 'Super']) {
        if (capturedKeys.modifiers.has(mod)) parts.push(mod);
      }
      parts.push(capturedKeys.code);
      const newHotkey = parts.join('+');

      try {
        await invoke('update_hotkey', { newHotkey });
        currentHotkey = newHotkey;
        renderKeycaps(document.getElementById('keycaps'), currentHotkey);
      } catch (e) {
        console.error('Failed to update hotkey:', e);
      }

      cancelCapture();
    }

    function buildSettingsPayload() {
      return {
        hotkey: currentHotkey,
        auto_paste: true,
        polish: {
          enabled: polishConfig.enabled,
          model: polishConfig.model,
          output_language: polishConfig.output_language,
          custom_prompt: null,
          mode: polishConfig.mode,
          cloud: {
            provider: polishConfig.cloud.provider,
            endpoint: polishConfig.cloud.endpoint,
            model_id: polishConfig.cloud.model_id,
          },
          prompt_rules: polishConfig.prompt_rules,
          dictionary: polishConfig.dictionary,
          reasoning: polishConfig.reasoning,
        },
        stt: {
          mode: sttConfig.mode,
          cloud: {
            provider: sttConfig.cloud.provider,
            endpoint: sttConfig.cloud.endpoint,
            model_id: sttConfig.cloud.model_id,
            language: sttConfig.cloud.language,
          },
        },
      };
    }

    // ── Confirm Modal ──

    let confirmResolve = null;

    function showConfirm(title, message) {
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmOverlay').classList.add('active');
      return new Promise(resolve => {
        confirmResolve = resolve;
        document.getElementById('confirmOkBtn').onclick = () => {
          confirmResolve = null;
          document.getElementById('confirmOverlay').classList.remove('active');
          resolve(true);
        };
      });
    }

    function closeConfirm() {
      document.getElementById('confirmOverlay').classList.remove('active');
      if (confirmResolve) { confirmResolve(false); confirmResolve = null; }
    }

    // ── Reset to Defaults ──

    async function resetSettings() {
      const ok = await showConfirm(
        t('confirm.resetTitle'),
        t('confirm.resetMessage')
      );
      if (!ok) return;
      try {
        await invoke('reset_settings');
        await loadSettings();
      } catch (e) {
        console.error('Failed to reset settings:', e);
      }
    }

    // ── AI Polishing ──

    function updatePolishUI() {
      const sub = document.getElementById('polishSub');
      if (polishConfig.enabled) {
        sub.classList.add('visible');
      } else {
        sub.classList.remove('visible');
      }

      // Update mode segmented control
      const modeBtns = document.querySelectorAll('#polishModeControl button');
      modeBtns[0].classList.toggle('active', polishConfig.mode === 'local');
      modeBtns[1].classList.toggle('active', polishConfig.mode === 'cloud');

      // Toggle local/cloud panels
      const localPanel = document.getElementById('polishLocalPanel');
      const cloudPanel = document.getElementById('polishCloudPanel');
      if (polishConfig.mode === 'cloud') {
        localPanel.classList.remove('visible');
        cloudPanel.classList.add('visible');
      } else {
        localPanel.classList.add('visible');
        cloudPanel.classList.remove('visible');
      }

      // Update local model segmented control
      const btns = document.querySelectorAll('#polishModelControl button');
      btns[0].classList.toggle('active', polishConfig.model === 'llama_taiwan');
      btns[1].classList.toggle('active', polishConfig.model === 'qwen25');

      // Update model card name and size
      const name = polishConfig.model === 'llama_taiwan' ? 'Llama 3 Taiwan 8B' : 'Qwen 2.5 7B';
      document.getElementById('polishModelName').textContent = name;
      const size = polishConfig.model === 'llama_taiwan' ? 'Q4_K_M (~4.6 GB)' : 'Q4_K_M (~4.6 GB)';
      document.getElementById('polishModelSize').textContent = size;

      // Show/hide endpoint row (only for Custom provider)
      const endpointRow = document.getElementById('cloudEndpointRow');
      endpointRow.style.display = polishConfig.cloud.provider === 'custom' ? '' : 'none';

      // Show/hide provider API key link button
      const providerData = CLOUD_PROVIDERS[polishConfig.cloud.provider];
      const linkBtn = document.getElementById('providerLinkBtn');
      linkBtn.style.display = (providerData && providerData.apiKeyUrl) ? '' : 'none';
    }

    async function openProviderApiPage() {
      const providerData = CLOUD_PROVIDERS[polishConfig.cloud.provider];
      if (providerData && providerData.apiKeyUrl) {
        await window.__TAURI__.opener.openUrl(providerData.apiKeyUrl);
      }
    }

    function togglePolish() {
      polishConfig.enabled = document.getElementById('polishToggle').checked;
      updatePolishUI();
      savePolishSettings();
    }

    function onPolishReasoningChange() {
      polishConfig.reasoning = document.getElementById('polishReasoningToggle').checked;
      savePolishSettings();
    }

    function selectPolishModel(model) {
      polishConfig.model = model;
      updatePolishUI();
      savePolishSettings();

      // If switching to the model that's currently downloading, show its progress
      if (llmDownloadingModel && llmDownloadingModel === model) {
        const btn = document.getElementById('polishDownloadBtn');
        btn.textContent = t('settings.polish.downloading');
        btn.disabled = true;
        document.getElementById('polishProgressWrap').style.display = '';
      } else {
        // Otherwise check the real status of the newly selected model
        checkLlmModelStatus();
      }
    }

    async function savePolishSettings() {
      polishConfig.output_language = document.getElementById('polishLangSelect').value;
      // Initialize prompt rules for new language with localized defaults if empty
      const lang = polishConfig.output_language;
      if (!polishConfig.prompt_rules[lang]) {
        try {
          polishConfig.prompt_rules[lang] = await invoke('get_default_prompt_rules', { language: lang });
        } catch (e) {
          polishConfig.prompt_rules[lang] = [];
        }
      }
      try {
        await invoke('save_settings', { newSettings: buildSettingsPayload() });
        renderPromptRules();
      } catch (e) {
        console.error('Failed to save polish settings:', e);
      }
    }

    async function checkLlmModelStatus() {
      try {
        const status = await invoke('check_llm_model_status');
        const btn = document.getElementById('polishDownloadBtn');
        const progressWrap = document.getElementById('polishProgressWrap');
        if (status.model_exists) {
          btn.textContent = t('settings.polish.downloaded');
          btn.classList.add('downloaded');
          btn.disabled = true;
          progressWrap.style.display = 'none';
        } else {
          btn.textContent = t('settings.polish.download');
          btn.classList.remove('downloaded');
          btn.disabled = false;
        }
      } catch (e) {
        console.error('Failed to check LLM model status:', e);
      }
    }

    async function startLlmModelDownload() {
      const btn = document.getElementById('polishDownloadBtn');
      btn.textContent = t('settings.polish.downloading');
      btn.disabled = true;
      llmDownloadingModel = polishConfig.model;

      const progressWrap = document.getElementById('polishProgressWrap');
      progressWrap.style.display = '';
      document.getElementById('polishProgressFill').style.width = '0%';
      document.getElementById('polishProgressPercent').textContent = '0%';
      document.getElementById('polishProgressSize').textContent = '0 MB / 0 MB';

      if (llmDownloadUnlisten) {
        llmDownloadUnlisten();
        llmDownloadUnlisten = null;
      }

      llmDownloadUnlisten = await window.__TAURI__.event.listen('llm-model-download-progress', (e) => {
        const d = e.payload;
        if (d.status === 'downloading') {
          // Only update UI if user is still viewing the downloading model
          if (polishConfig.model === llmDownloadingModel) {
            const pct = Math.min(d.percent, 100).toFixed(1);
            document.getElementById('polishProgressFill').style.width = pct + '%';
            document.getElementById('polishProgressPercent').textContent = Math.round(d.percent) + '%';
            document.getElementById('polishProgressSize').textContent =
              formatBytes(d.downloaded) + ' / ' + formatBytes(d.total);
          }
        } else if (d.status === 'complete') {
          const completedModel = llmDownloadingModel;
          llmDownloadingModel = null;
          // Update UI if viewing the model that just completed
          if (polishConfig.model === completedModel) {
            btn.textContent = t('settings.polish.downloaded');
            btn.classList.add('downloaded');
            btn.disabled = true;
            progressWrap.style.display = 'none';
          }
          if (llmDownloadUnlisten) {
            llmDownloadUnlisten();
            llmDownloadUnlisten = null;
          }
        } else if (d.status === 'error') {
          llmDownloadingModel = null;
          btn.textContent = t('settings.polish.retry');
          btn.classList.remove('downloaded');
          btn.disabled = false;
          progressWrap.style.display = 'none';
          console.error('LLM download error:', d.message);
          if (llmDownloadUnlisten) {
            llmDownloadUnlisten();
            llmDownloadUnlisten = null;
          }
        }
      });

      try {
        await invoke('download_llm_model');
      } catch (e) {
        llmDownloadingModel = null;
        btn.textContent = t('settings.polish.retry');
        btn.disabled = false;
        progressWrap.style.display = 'none';
        console.error('Failed to start LLM download:', e);
      }
    }


    // ── STT Cloud mode ──

    function selectSttMode(mode) {
      sttConfig.mode = mode;
      updateSttUI();
      saveSttSettings();
    }

    function updateSttUI() {
      const modeBtns = document.querySelectorAll('#sttModeControl button');
      modeBtns[0].classList.toggle('active', sttConfig.mode === 'local');
      modeBtns[1].classList.toggle('active', sttConfig.mode === 'cloud');

      const localPanel = document.getElementById('sttLocalPanel');
      const cloudPanel = document.getElementById('sttCloudPanel');
      if (sttConfig.mode === 'cloud') {
        localPanel.classList.remove('visible');
        cloudPanel.classList.add('visible');
      } else {
        localPanel.classList.add('visible');
        cloudPanel.classList.remove('visible');
      }

      // Azure: show region input; Custom: show endpoint input; others: hide both
      const isAzure = sttConfig.cloud.provider === 'azure';
      const isCustom = sttConfig.cloud.provider === 'custom';
      document.getElementById('sttAzureRegionRow').style.display = isAzure ? '' : 'none';
      document.getElementById('sttEndpointRow').style.display = isCustom ? '' : 'none';

      // Show/hide provider API key link button
      const providerData = STT_CLOUD_PROVIDERS[sttConfig.cloud.provider];
      const linkBtn = document.getElementById('sttProviderLinkBtn');
      linkBtn.style.display = (providerData && providerData.apiKeyUrl) ? '' : 'none';
    }

    function populateSttModels() {
      const select = document.getElementById('sttModelSelect');
      const selectRow = document.getElementById('sttModelSelectRow');
      const customRow = document.getElementById('sttCustomModelRow');
      const customInput = document.getElementById('sttCustomModelInput');
      const provider = sttConfig.cloud.provider;
      const providerData = STT_CLOUD_PROVIDERS[provider] || { models: [] };

      // Azure has no model parameter — hide both model rows
      if (provider === 'azure') {
        selectRow.style.display = 'none';
        customRow.style.display = 'none';
        return;
      }

      if (providerData.models.length === 0) {
        selectRow.style.display = 'none';
        customRow.style.display = '';
        customInput.value = sttConfig.cloud.model_id || '';
        return;
      }

      selectRow.style.display = '';
      select.innerHTML = '';

      for (const m of providerData.models) {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.name;
        select.appendChild(opt);
      }

      // Add "Custom..." option
      const customOpt = document.createElement('option');
      customOpt.value = '__custom__';
      customOpt.textContent = 'Custom...';
      select.appendChild(customOpt);

      const knownIds = providerData.models.map(m => m.id);
      if (knownIds.includes(sttConfig.cloud.model_id)) {
        select.value = sttConfig.cloud.model_id;
        customRow.style.display = 'none';
      } else {
        select.value = '__custom__';
        customInput.value = sttConfig.cloud.model_id || '';
        customRow.style.display = '';
      }
    }

    async function onSttProviderChange() {
      const provider = document.getElementById('sttProviderSelect').value;
      sttConfig.cloud.provider = provider;

      const providerData = STT_CLOUD_PROVIDERS[provider] || { models: [] };
      if (providerData.models.length > 0) {
        sttConfig.cloud.model_id = providerData.models[0].id;
      } else {
        sttConfig.cloud.model_id = '';
      }

      // Load API key from keychain for the new provider
      try {
        const key = await invoke('get_api_key', { provider: 'stt_' + provider });
        sttConfig.cloud.api_key = key;
        document.getElementById('sttApiKeyInput').value = key;
      } catch (e) {
        console.warn('Failed to load STT API key from keychain:', e);
        sttConfig.cloud.api_key = '';
        document.getElementById('sttApiKeyInput').value = '';
      }

      populateSttModels();
      updateSttUI();
      saveSttSettings();
    }

    function onSttModelChange() {
      const select = document.getElementById('sttModelSelect');
      const customRow = document.getElementById('sttCustomModelRow');
      if (select.value === '__custom__') {
        customRow.style.display = '';
        sttConfig.cloud.model_id = document.getElementById('sttCustomModelInput').value;
      } else {
        customRow.style.display = 'none';
        sttConfig.cloud.model_id = select.value;
      }
      saveSttSettings();
    }

    async function onSttCloudConfigChange() {
      const newKey = document.getElementById('sttApiKeyInput').value;
      if (sttConfig.cloud.provider === 'azure') {
        sttConfig.cloud.endpoint = document.getElementById('sttAzureRegionInput').value;
      } else {
        sttConfig.cloud.endpoint = document.getElementById('sttEndpointInput').value;
      }
      sttConfig.cloud.language = document.getElementById('sttLanguageSelect').value;

      if (newKey !== sttConfig.cloud.api_key) {
        sttConfig.cloud.api_key = newKey;
        try {
          await invoke('save_api_key', { provider: 'stt_' + sttConfig.cloud.provider, key: newKey });
        } catch (e) {
          console.error('Failed to save STT API key to keychain:', e);
        }
      }

      const select = document.getElementById('sttModelSelect');
      if (select.value === '__custom__') {
        sttConfig.cloud.model_id = document.getElementById('sttCustomModelInput').value;
      }

      saveSttSettings();
    }

    function onSttCustomModelInput() {
      sttConfig.cloud.model_id = document.getElementById('sttCustomModelInput').value;
    }

    async function openSttProviderApiPage() {
      const providerData = STT_CLOUD_PROVIDERS[sttConfig.cloud.provider];
      if (providerData && providerData.apiKeyUrl) {
        await window.__TAURI__.opener.openUrl(providerData.apiKeyUrl);
      }
    }

    async function saveSttSettings() {
      try {
        await invoke('save_settings', { newSettings: buildSettingsPayload() });
      } catch (e) {
        console.error('Failed to save STT settings:', e);
      }
    }

    async function startSttModelDownload() {
      const btn = document.getElementById('sttModelDownloadBtn');
      btn.textContent = t('settings.polish.downloading');
      btn.disabled = true;
      document.getElementById('sttModelProgressWrap').style.display = '';

      if (sttModelDownloadUnlisten) sttModelDownloadUnlisten();
      sttModelDownloadUnlisten = await listen('model-download-progress', (event) => {
        const d = event.payload;
        if (d.status === 'downloading') {
          const pct = d.percent.toFixed(1);
          document.getElementById('sttModelProgressFill').style.width = pct + '%';
          document.getElementById('sttModelProgressPercent').textContent = pct + '%';
          const dlMB = (d.downloaded / 1048576).toFixed(0);
          const totMB = (d.total / 1048576).toFixed(0);
          document.getElementById('sttModelProgressSize').textContent = dlMB + ' MB / ' + totMB + ' MB';
        } else if (d.status === 'complete') {
          document.getElementById('sttModelProgressWrap').style.display = 'none';
          btn.textContent = t('settings.polish.downloaded');
          btn.classList.add('downloaded');
          btn.disabled = true;
          if (sttModelDownloadUnlisten) { sttModelDownloadUnlisten(); sttModelDownloadUnlisten = null; }
        } else if (d.status === 'error') {
          document.getElementById('sttModelProgressWrap').style.display = 'none';
          btn.textContent = t('settings.polish.retry');
          btn.disabled = false;
          console.error('STT model download error:', d.message);
          if (sttModelDownloadUnlisten) { sttModelDownloadUnlisten(); sttModelDownloadUnlisten = null; }
        }
      });

      try {
        await invoke('download_model');
      } catch (e) {
        btn.textContent = t('settings.polish.retry');
        btn.disabled = false;
        document.getElementById('sttModelProgressWrap').style.display = 'none';
        console.error('Failed to start STT model download:', e);
      }
    }

    async function checkSttModelStatus() {
      try {
        const status = await invoke('check_model_status');
        const btn = document.getElementById('sttModelDownloadBtn');
        if (status.model_exists) {
          btn.textContent = t('settings.polish.downloaded');
          btn.classList.add('downloaded');
          btn.disabled = true;
        } else {
          btn.textContent = t('settings.polish.download');
          btn.classList.remove('downloaded');
          btn.disabled = false;
        }
      } catch (e) {
        console.error('Failed to check STT model status:', e);
      }
    }

    // ── Cloud mode ──

    function selectPolishMode(mode) {
      polishConfig.mode = mode;
      updatePolishUI();
      savePolishSettings();
    }

    function populateCloudModels() {
      const select = document.getElementById('cloudModelSelect');
      const selectRow = document.getElementById('cloudModelSelectRow');
      const customRow = document.getElementById('cloudCustomModelRow');
      const customInput = document.getElementById('cloudCustomModelInput');
      const provider = polishConfig.cloud.provider;
      const providerData = CLOUD_PROVIDERS[provider] || { models: [] };

      if (providerData.models.length === 0) {
        // No predefined models — show text input directly, hide dropdown
        selectRow.style.display = 'none';
        customRow.style.display = '';
        customInput.value = polishConfig.cloud.model_id || '';
        return;
      }

      // Provider has predefined models — show dropdown
      selectRow.style.display = '';
      select.innerHTML = '';

      for (const m of providerData.models) {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.name;
        select.appendChild(opt);
      }

      // Add "Custom..." option
      const customOpt = document.createElement('option');
      customOpt.value = '__custom__';
      customOpt.textContent = 'Custom...';
      select.appendChild(customOpt);

      // Set current value
      const knownIds = providerData.models.map(m => m.id);
      if (knownIds.includes(polishConfig.cloud.model_id)) {
        select.value = polishConfig.cloud.model_id;
        customRow.style.display = 'none';
      } else {
        select.value = '__custom__';
        customInput.value = polishConfig.cloud.model_id || '';
        customRow.style.display = '';
      }
    }

    async function onProviderChange() {
      const provider = document.getElementById('cloudProviderSelect').value;
      polishConfig.cloud.provider = provider;

      // Reset model to first available for this provider
      const providerData = CLOUD_PROVIDERS[provider] || { models: [] };
      if (providerData.models.length > 0) {
        polishConfig.cloud.model_id = providerData.models[0].id;
      } else {
        polishConfig.cloud.model_id = '';
      }

      // Load API key from keychain for the new provider
      try {
        const key = await invoke('get_api_key', { provider });
        polishConfig.cloud.api_key = key;
        document.getElementById('cloudApiKeyInput').value = key;
      } catch (e) {
        console.warn('Failed to load API key from keychain:', e);
        polishConfig.cloud.api_key = '';
        document.getElementById('cloudApiKeyInput').value = '';
      }

      populateCloudModels();
      updatePolishUI();
      savePolishSettings();
    }

    function onCloudModelChange() {
      const select = document.getElementById('cloudModelSelect');
      const customRow = document.getElementById('cloudCustomModelRow');
      if (select.value === '__custom__') {
        customRow.style.display = '';
        polishConfig.cloud.model_id = document.getElementById('cloudCustomModelInput').value;
      } else {
        customRow.style.display = 'none';
        polishConfig.cloud.model_id = select.value;
      }
      savePolishSettings();
    }

    async function onCloudConfigChange() {
      const newKey = document.getElementById('cloudApiKeyInput').value;
      polishConfig.cloud.endpoint = document.getElementById('cloudEndpointInput').value;

      // Save API key to keychain if it changed
      if (newKey !== polishConfig.cloud.api_key) {
        polishConfig.cloud.api_key = newKey;
        try {
          await invoke('save_api_key', { provider: polishConfig.cloud.provider, key: newKey });
        } catch (e) {
          console.error('Failed to save API key to keychain:', e);
        }
      }

      // If custom model input changed
      const select = document.getElementById('cloudModelSelect');
      if (select.value === '__custom__') {
        polishConfig.cloud.model_id = document.getElementById('cloudCustomModelInput').value;
      }

      savePolishSettings();
    }

    function onCustomModelInput() {
      polishConfig.cloud.model_id = document.getElementById('cloudCustomModelInput').value;
    }

    // ── Prompt Rules ──

    let expandedRuleIndex = -1;

    const RULE_ICON_SVG = {
      // Gmail
      gmail: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#EA4335" d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z"/></svg>',
      // Notion
      notion: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 1.968c-.42-.326-.981-.7-2.055-.607L3.01 2.295c-.466.046-.56.28-.374.466zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046.935-.56.935-1.167V6.354c0-.606-.233-.933-.748-.887l-15.177.887c-.56.047-.747.327-.747.933zm14.337.745c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.748 0-.935-.234-1.495-.933l-4.577-7.186v6.952L12.21 19s0 .84-1.168.84l-3.222.186c-.093-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.139c-.093-.514.28-.887.747-.933zM1.936 1.035l13.31-.98c1.634-.14 2.055-.047 3.082.7l4.249 2.986c.7.513.934.653.934 1.213v16.378c0 1.026-.373 1.634-1.68 1.726l-15.458.934c-.98.047-1.448-.093-1.962-.747l-3.129-4.06c-.56-.747-.793-1.306-.793-1.96V2.667c0-.839.374-1.54 1.447-1.632z"/></svg>',
      // Google Chrome
      chrome: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#4285F4" d="M12 0C8.21 0 4.831 1.757 2.632 4.501l3.953 6.848A5.454 5.454 0 0 1 12 6.545h10.691A12 12 0 0 0 12 0zM1.931 5.47A11.943 11.943 0 0 0 0 12c0 6.012 4.42 10.991 10.189 11.864l3.953-6.847a5.45 5.45 0 0 1-6.865-2.29zm13.342 2.166a5.446 5.446 0 0 1 1.45 7.09l.002.001h-.002l-5.344 9.257c.206.01.413.016.621.016 6.627 0 12-5.373 12-12 0-1.54-.29-3.011-.818-4.364zM12 16.364a4.364 4.364 0 1 1 0-8.728 4.364 4.364 0 0 1 0 8.728Z"/></svg>',
      // Slack
      slack: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#4A154B" d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/></svg>',
      // Discord
      discord: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#5865F2" d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189Z"/></svg>',
      // Visual Studio Code
      vscode: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#007ACC" d="M23.15 2.587L18.21.21a1.494 1.494 0 0 0-1.705.29l-9.46 8.63-4.12-3.128a.999.999 0 0 0-1.276.057L.327 7.261A1 1 0 0 0 .326 8.74L3.899 12 .326 15.26a1 1 0 0 0 .001 1.479L1.65 17.94a.999.999 0 0 0 1.276.057l4.12-3.128 9.46 8.63a1.492 1.492 0 0 0 1.704.29l4.942-2.377A1.5 1.5 0 0 0 24 20.06V3.939a1.5 1.5 0 0 0-.85-1.352zm-5.146 14.861L10.826 12l7.178-5.448v10.896z"/></svg>',
      // Firefox
      firefox: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#FF7139" d="M20.452 3.445a11.002 11.002 0 00-2.482-1.908C16.944.997 15.098.093 12.477.032c-.734-.017-1.457.03-2.174.144-.72.114-1.398.292-2.118.56-1.017.377-1.996.975-2.574 1.554.583-.349 1.476-.733 2.55-.992a10.083 10.083 0 013.729-.167c2.341.34 4.178 1.381 5.48 2.625a8.066 8.066 0 011.298 1.587c1.468 2.382 1.33 5.376.184 7.142-.85 1.312-2.67 2.544-4.37 2.53-.583-.023-1.438-.152-2.25-.566-2.629-1.343-3.021-4.688-1.118-6.306-.632-.136-1.82.13-2.646 1.363-.742 1.107-.7 2.816-.242 4.028a6.473 6.473 0 01-.59-1.895 7.695 7.695 0 01.416-3.845A8.212 8.212 0 019.45 5.399c.896-1.069 1.908-1.72 2.75-2.005-.54-.471-1.411-.738-2.421-.767C8.31 2.583 6.327 3.061 4.7 4.41a8.148 8.148 0 00-1.976 2.414c-.455.836-.691 1.659-.697 1.678.122-1.445.704-2.994 1.248-4.055-.79.413-1.827 1.668-2.41 3.042C.095 9.37-.2 11.608.14 13.989c.966 5.668 5.9 9.982 11.843 9.982C18.62 23.971 24 18.591 24 11.956a11.93 11.93 0 00-3.548-8.511z"/></svg>',
      // GitHub
      github: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>',
      // X (Twitter)
      twitter: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg>',
      // YouTube
      youtube: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#FF0000" d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>',
      // Telegram
      telegram: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#26A5E4" d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>',
      // WhatsApp
      whatsapp: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#25D366" d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>',
      // WeChat
      wechat: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#07C160" d="M8.691 2.188C3.891 2.188 0 5.476 0 9.53c0 2.212 1.17 4.203 3.002 5.55a.59.59 0 0 1 .213.665l-.39 1.48c-.019.07-.048.141-.048.213 0 .163.13.295.29.295a.326.326 0 0 0 .167-.054l1.903-1.114a.864.864 0 0 1 .717-.098 10.16 10.16 0 0 0 2.837.403c.276 0 .543-.027.811-.05-.857-2.578.157-4.972 1.932-6.446 1.703-1.415 3.882-1.98 5.853-1.838-.576-3.583-4.196-6.348-8.596-6.348zM5.785 5.991c.642 0 1.162.529 1.162 1.18a1.17 1.17 0 0 1-1.162 1.178A1.17 1.17 0 0 1 4.623 7.17c0-.651.52-1.18 1.162-1.18zm5.813 0c.642 0 1.162.529 1.162 1.18a1.17 1.17 0 0 1-1.162 1.178 1.17 1.17 0 0 1-1.162-1.178c0-.651.52-1.18 1.162-1.18zm5.34 2.867c-1.797-.052-3.746.512-5.28 1.786-1.72 1.428-2.687 3.72-1.78 6.22.942 2.453 3.666 4.229 6.884 4.229.826 0 1.622-.12 2.361-.336a.722.722 0 0 1 .598.082l1.584.926a.272.272 0 0 0 .14.047c.134 0 .24-.111.24-.247 0-.06-.023-.12-.038-.177l-.327-1.233a.582.582 0 0 1-.023-.156.49.49 0 0 1 .201-.398C23.024 18.48 24 16.82 24 14.98c0-3.21-2.931-5.837-6.656-6.088V8.89c-.135-.01-.27-.027-.407-.03zm-2.53 3.274c.535 0 .969.44.969.982a.976.976 0 0 1-.969.983.976.976 0 0 1-.969-.983c0-.542.434-.982.97-.982zm4.844 0c.535 0 .969.44.969.982a.976.976 0 0 1-.969.983.976.976 0 0 1-.969-.983c0-.542.434-.982.969-.982z"/></svg>',
      // LINE
      line: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#00C300" d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/></svg>',
      // Figma
      figma: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#F24E1E" d="M15.852 8.981h-4.588V0h4.588c2.476 0 4.49 2.014 4.49 4.49s-2.014 4.491-4.49 4.491zM12.735 7.51h3.117c1.665 0 3.019-1.355 3.019-3.019s-1.355-3.019-3.019-3.019h-3.117V7.51zm0 1.471H8.148c-2.476 0-4.49-2.014-4.49-4.49S5.672 0 8.148 0h4.588v8.981zm-4.587-7.51c-1.665 0-3.019 1.355-3.019 3.019s1.354 3.02 3.019 3.02h3.117V1.471H8.148zm4.587 15.019H8.148c-2.476 0-4.49-2.014-4.49-4.49s2.014-4.49 4.49-4.49h4.588v8.98zM8.148 8.981c-1.665 0-3.019 1.355-3.019 3.019s1.355 3.019 3.019 3.019h3.117V8.981H8.148zM8.172 24c-2.489 0-4.515-2.014-4.515-4.49s2.014-4.49 4.49-4.49h4.588v4.441c0 2.503-2.047 4.539-4.563 4.539zm-.024-7.51a3.023 3.023 0 0 0-3.019 3.019c0 1.665 1.365 3.019 3.044 3.019 1.705 0 3.093-1.376 3.093-3.068v-2.97H8.148zm7.704 0h-.098c-2.476 0-4.49-2.014-4.49-4.49s2.014-4.49 4.49-4.49h.098c2.476 0 4.49 2.014 4.49 4.49s-2.014 4.49-4.49 4.49zm-.097-7.509c-1.665 0-3.019 1.355-3.019 3.019s1.355 3.019 3.019 3.019h.098c1.665 0 3.019-1.355 3.019-3.019s-1.355-3.019-3.019-3.019h-.098z"/></svg>',
      // Apple (Safari, Notes, etc.)
      apple: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M12.152 6.896c-.948 0-2.415-1.078-3.96-1.04-2.04.027-3.91 1.183-4.961 3.014-2.117 3.675-.546 9.103 1.519 12.09 1.013 1.454 2.208 3.09 3.792 3.039 1.52-.065 2.09-.987 3.935-.987 1.831 0 2.35.987 3.96.948 1.637-.026 2.676-1.48 3.676-2.948 1.156-1.688 1.636-3.325 1.662-3.415-.039-.013-3.182-1.221-3.22-4.857-.026-3.04 2.48-4.494 2.597-4.559-1.429-2.09-3.623-2.324-4.39-2.376-2-.156-3.675 1.09-4.61 1.09zM15.53 3.83c.843-1.012 1.4-2.427 1.245-3.83-1.207.052-2.662.805-3.532 1.818-.78.896-1.454 2.338-1.273 3.714 1.338.104 2.715-.688 3.559-1.701"/></svg>',
      // Microsoft Word
      word: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#2B579A" d="M23.004 1.5q.41 0 .703.293t.293.703v19.008q0 .41-.293.703t-.703.293H6.996q-.41 0-.703-.293T6 21.504V18H.996q-.41 0-.703-.293T0 17.004V6.996q0-.41.293-.703T.996 6H6V2.496q0-.41.293-.703t.703-.293zM6.035 11.203l1.442 4.735h1.64l1.57-7.876H9.036l-.937 4.653-1.325-4.5H5.38l-1.406 4.523-.938-4.675H1.312l1.57 7.874h1.641zM22.5 21v-3h-15v3zm0-4.5v-3.75H12v3.75zm0-5.25V7.5H12v3.75zm0-5.25V3h-15v3Z"/></svg>',
      // Microsoft Excel
      excel: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#217346" d="M23 1.5q.41 0 .7.3.3.29.3.7v19q0 .41-.3.7-.29.3-.7.3H7q-.41 0-.7-.3-.3-.29-.3-.7V18H1q-.41 0-.7-.3-.3-.29-.3-.7V7q0-.41.3-.7Q.58 6 1 6h5V2.5q0-.41.3-.7.29-.3.7-.3zM6 13.28l1.42 2.66h2.14l-2.38-3.87 2.34-3.8H7.46l-1.3 2.4-.05.08-.04.09-.64-1.28-.66-1.29H2.59l2.27 3.82-2.48 3.85h2.16zM14.25 21v-3H7.5v3zm0-4.5v-3.75H12v3.75zm0-5.25V7.5H12v3.75zm0-5.25V3H7.5v3zm8.25 15v-3h-6.75v3zm0-4.5v-3.75h-6.75v3.75zm0-5.25V7.5h-6.75v3.75zm0-5.25V3h-6.75v3Z"/></svg>',
      // Microsoft Teams
      teams: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#6264A7" d="M20.625 8.127q-.55 0-1.025-.205-.475-.205-.832-.563-.358-.357-.563-.832Q18 6.053 18 5.502q0-.54.205-1.02t.563-.837q.357-.358.832-.563.474-.205 1.025-.205.54 0 1.02.205t.837.563q.358.357.563.837.205.48.205 1.02 0 .55-.205 1.025-.205.475-.563.832-.357.358-.837.563-.48.205-1.02.205zm0-3.75q-.469 0-.797.328-.328.328-.328.797 0 .469.328.797.328.328.797.328.469 0 .797-.328.328-.328.328-.797 0-.469-.328-.797-.328-.328-.797-.328zM24 10.002v5.578q0 .774-.293 1.46-.293.685-.803 1.194-.51.51-1.195.803-.686.293-1.459.293-.445 0-.908-.105-.463-.106-.85-.329-.293.95-.855 1.729-.563.78-1.319 1.336-.756.557-1.67.861-.914.305-1.898.305-1.148 0-2.162-.398-1.014-.399-1.805-1.102-.79-.703-1.312-1.664t-.674-2.086h-5.8q-.411 0-.704-.293T0 16.881V6.873q0-.41.293-.703t.703-.293h8.59q-.34-.715-.34-1.5 0-.727.275-1.365.276-.639.75-1.114.475-.474 1.114-.75.638-.275 1.365-.275t1.365.275q.639.276 1.114.75.474.475.75 1.114.275.638.275 1.365t-.275 1.365q-.276.639-.75 1.113-.475.475-1.114.75-.638.276-1.365.276-.188 0-.375-.024-.188-.023-.375-.058v1.078h10.875q.469 0 .797.328.328.328.328.797zM12.75 2.373q-.41 0-.78.158-.368.158-.638.434-.27.275-.428.639-.158.363-.158.773 0 .41.158.78.159.368.428.638.27.27.639.428.369.158.779.158.41 0 .773-.158.364-.159.64-.428.274-.27.433-.639.158-.369.158-.779 0-.41-.158-.773-.159-.364-.434-.64-.275-.275-.639-.433-.363-.158-.773-.158zM6.937 9.814h2.25V7.94H2.814v1.875h2.25v6h1.875zm10.313 7.313v-6.75H12v6.504q0 .41-.293.703t-.703.293H8.309q.152.809.556 1.5.405.691.985 1.19.58.497 1.318.779.738.281 1.582.281.926 0 1.746-.352.82-.351 1.436-.966.615-.616.966-1.43.352-.815.352-1.752zm5.25-1.547v-5.203h-3.75v6.855q.305.305.691.452.387.146.809.146.469 0 .879-.176.41-.175.715-.48.304-.305.48-.715t.176-.879Z"/></svg>',
      // Linear
      linear: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#5E6AD2" d="M2.886 4.18A11.982 11.982 0 0 1 11.99 0C18.624 0 24 5.376 24 12.009c0 3.64-1.62 6.903-4.18 9.105L2.887 4.18ZM1.817 5.626l16.556 16.556c-.524.33-1.075.62-1.65.866L.951 7.277c.247-.575.537-1.126.866-1.65ZM.322 9.163l14.515 14.515c-.71.172-1.443.282-2.195.322L0 11.358a12 12 0 0 1 .322-2.195Zm-.17 4.862 9.823 9.824a12.02 12.02 0 0 1-9.824-9.824Z"/></svg>',
    };

    // Keywords → icon key mapping (case-insensitive match against rule name + match_value)
    const RULE_ICON_KEYWORDS = [
      { keys: ['gmail', 'mail.google'], icon: 'gmail' },
      { keys: ['notion'], icon: 'notion' },
      { keys: ['chrome', 'google chrome', 'googlechrome'], icon: 'chrome' },
      { keys: ['slack'], icon: 'slack' },
      { keys: ['discord'], icon: 'discord' },
      { keys: ['vscode', 'visual studio code', 'code.app'], icon: 'vscode' },
      { keys: ['cursor'], icon: 'vscode' },
      { keys: ['firefox'], icon: 'firefox' },
      { keys: ['github'], icon: 'github' },
      { keys: ['twitter', 'x.com', 'tweetdeck'], icon: 'twitter' },
      { keys: ['youtube'], icon: 'youtube' },
      { keys: ['telegram'], icon: 'telegram' },
      { keys: ['whatsapp'], icon: 'whatsapp' },
      { keys: ['wechat', 'weixin', '微信'], icon: 'wechat' },
      { keys: ['line'], icon: 'line' },
      { keys: ['figma'], icon: 'figma' },
      { keys: ['safari'], icon: 'apple' },
      { keys: ['notes', 'pages', 'keynote', 'xcode', 'finder', 'terminal', 'iterm'], icon: 'apple' },
      { keys: ['word', 'winword'], icon: 'word' },
      { keys: ['excel'], icon: 'excel' },
      { keys: ['teams'], icon: 'teams' },
      { keys: ['linear'], icon: 'linear' },
    ];

    // Fallback generic icons per match_type
    const FALLBACK_ICON_SVG = {
      url: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>',
      app_name: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M4 4h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm0 2v12h16V6H4zm1 1h5v2H5V7z"/></svg>',
      bundle_id: '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M21 16.5c0 .38-.21.71-.53.88l-7.9 4.44c-.16.12-.36.18-.57.18-.21 0-.41-.06-.57-.18l-7.9-4.44A.991.991 0 0 1 3 16.5v-9c0-.38.21-.71.53-.88l7.9-4.44c.16-.12.36-.18.57-.18.21 0 .41.06.57.18l7.9 4.44c.32.17.53.5.53.88v9zM12 4.15L6.04 7.5 12 10.85l5.96-3.35L12 4.15zM5 15.91l6 3.38v-6.71L5 9.21v6.7zm14 0v-6.7l-6 3.37v6.71l6-3.38z"/></svg>',
    };

    function getRuleIcon(rule) {
      const searchText = ((rule.name || '') + ' ' + (rule.match_value || '')).toLowerCase();
      for (const entry of RULE_ICON_KEYWORDS) {
        for (const key of entry.keys) {
          if (searchText.includes(key.toLowerCase())) {
            return RULE_ICON_SVG[entry.icon];
          }
        }
      }
      return FALLBACK_ICON_SVG[rule.match_type] || FALLBACK_ICON_SVG.app_name;
    }

    function toggleRuleExpand(index) {
      if (expandedRuleIndex === index) {
        expandedRuleIndex = -1;
      } else {
        expandedRuleIndex = index;
      }
      const cards = document.querySelectorAll('.prompt-rule-card[data-rule-index]');
      cards.forEach(card => {
        const cardIndex = parseInt(card.getAttribute('data-rule-index'), 10);
        card.classList.toggle('expanded', cardIndex === expandedRuleIndex);
      });
    }

    async function renderPromptRules() {
      // Render base prompt card first
      const defaultCard = document.getElementById('defaultPromptCard');
      if (defaultCard) {
        try {
          const basePrompt = await invoke('get_default_prompt', { language: polishConfig.output_language });
          defaultCard.innerHTML = `<div class="default-prompt-card">
            <div class="prompt-rule-top">
              <span class="prompt-rule-name">
                <span class="default-prompt-badge">${t('promptRules.basePrompt')}</span>
              </span>
            </div>
            <div class="default-prompt-desc">${t('promptRules.basePromptDesc')}</div>
            <div class="prompt-rule-prompt">${escapeHtml(basePrompt)}</div>
          </div>`;
        } catch (e) {
          console.error('Failed to load base prompt:', e);
        }
      }

      // Render rules sorted alphabetically by name
      const container = document.getElementById('promptRulesList');
      const rules = getCurrentRules();
      if (!rules || rules.length === 0) {
        container.innerHTML = '<div class="prompt-rules-empty">' + t('settings.polish.noRules') + '</div>';
      } else {
        // Build sorted index array
        const sorted = rules.map((rule, i) => ({ rule, origIndex: i }));
        sorted.sort((a, b) => {
          const nameA = (a.rule.name || '').toLowerCase();
          const nameB = (b.rule.name || '').toLowerCase();
          return nameA.localeCompare(nameB);
        });

        const matchLabels = {
          app_name: t('settings.polish.matchAppName'),
          bundle_id: t('settings.polish.matchBundleId'),
          url: t('settings.polish.matchUrl'),
        };
        container.innerHTML = sorted.map(({ rule, origIndex }) => {
          const name = rule.name || t('settings.polish.untitledRule');
          const disabledClass = rule.enabled ? '' : ' disabled';
          const expandedClass = origIndex === expandedRuleIndex ? ' expanded' : '';
          const toggleLabel = rule.enabled ? t('settings.polish.disableRule') : t('settings.polish.enableRule');
          const matchLabel = matchLabels[rule.match_type] || rule.match_type;
          const icon = getRuleIcon(rule);
          return `<div class="prompt-rule-card${disabledClass}${expandedClass}" data-rule-index="${origIndex}">
            <div class="prompt-rule-header" onclick="toggleRuleExpand(${origIndex})">
              <span class="prompt-rule-icon">${icon}</span>
              <span class="prompt-rule-header-name">${escapeHtml(name)}</span>
              <span class="prompt-rule-chevron">▶</span>
            </div>
            <div class="prompt-rule-body">
              <div class="prompt-rule-body-inner">
                <div class="prompt-rule-match">${matchLabel}: ${escapeHtml(rule.match_value)}</div>
                <div class="prompt-rule-prompt"><strong>${t('settings.polish.rulePrompt')}:</strong> ${escapeHtml(rule.prompt || '')}</div>
                <div class="prompt-rule-actions">
                  <button onclick="event.stopPropagation(); toggleRule(${origIndex})">${toggleLabel}</button>
                  <button onclick="event.stopPropagation(); openRuleEditor(${origIndex})" title="${t('settings.polish.editRule')}">✎</button>
                  <button onclick="event.stopPropagation(); deleteRule(${origIndex})" title="${t('settings.polish.deleteRule')}">✕</button>
                </div>
              </div>
            </div>
          </div>`;
        }).join('');
      }
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function escapeAttr(str) {
      return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function openRuleEditor(index) {
      editingRuleIndex = index;
      const titleEl = document.getElementById('ruleEditorTitle');
      if (index >= 0) {
        const rule = getCurrentRules()[index];
        titleEl.textContent = t('settings.polish.editRule');
        document.getElementById('ruleNameInput').value = rule.name || '';
        document.getElementById('ruleMatchTypeSelect').value = rule.match_type || 'app_name';
        document.getElementById('ruleMatchValueInput').value = rule.match_value || '';
        document.getElementById('rulePromptInput').value = rule.prompt || '';
      } else {
        titleEl.textContent = t('settings.polish.addRule');
        document.getElementById('ruleNameInput').value = '';
        document.getElementById('ruleMatchTypeSelect').value = 'app_name';
        document.getElementById('ruleMatchValueInput').value = '';
        document.getElementById('rulePromptInput').value = '';
      }
      document.getElementById('ruleEditorOverlay').classList.add('active');
    }

    function closeRuleEditor() {
      document.getElementById('ruleEditorOverlay').classList.remove('active');
      editingRuleIndex = -1;
    }

    async function saveRuleEditor() {
      const name = document.getElementById('ruleNameInput').value.trim();
      const matchType = document.getElementById('ruleMatchTypeSelect').value;
      const matchValue = document.getElementById('ruleMatchValueInput').value.trim();
      const prompt = document.getElementById('rulePromptInput').value.trim();

      if (!matchValue) {
        document.getElementById('ruleMatchValueInput').focus();
        return;
      }
      if (!prompt) {
        document.getElementById('rulePromptInput').focus();
        return;
      }

      const rule = {
        name: name || t('settings.polish.untitledRule'),
        match_type: matchType,
        match_value: matchValue,
        prompt: prompt,
        enabled: true,
      };

      const rules = getCurrentRules().slice();
      if (editingRuleIndex >= 0) {
        rule.enabled = rules[editingRuleIndex].enabled;
        rules[editingRuleIndex] = rule;
      } else {
        rules.push(rule);
      }
      setCurrentRules(rules);

      closeRuleEditor();
      renderPromptRules();
      await savePolishSettings();
    }

    async function deleteRule(index) {
      const rules = getCurrentRules().slice();
      rules.splice(index, 1);
      setCurrentRules(rules);
      renderPromptRules();
      await savePolishSettings();
    }

    async function toggleRule(index) {
      const rules = getCurrentRules().slice();
      rules[index] = { ...rules[index], enabled: !rules[index].enabled };
      setCurrentRules(rules);
      renderPromptRules();
      await savePolishSettings();
    }

    // ── Dictionary ──

    function renderDictionary() {
      const container = document.getElementById('dictionaryList');
      const entries = polishConfig.dictionary.entries;
      document.getElementById('dictToggle').checked = polishConfig.dictionary.enabled;
      if (!entries || entries.length === 0) {
        container.innerHTML = `<div class="dictionary-empty">
          <div data-i18n="dictionary.emptyTitle">${t('dictionary.emptyTitle')}</div>
          <div class="dictionary-empty-hint" data-i18n="dictionary.emptyHint">${t('dictionary.emptyHint')}</div>
        </div>`;
      } else {
        container.innerHTML = entries.map((entry, i) => {
          const disabledClass = entry.enabled ? '' : ' disabled';
          const toggleLabel = entry.enabled ? t('dictionary.disable') : t('dictionary.enable');
          return `<div class="dictionary-card${disabledClass}">
            <div class="dictionary-card-top">
              <span class="dictionary-card-terms">${escapeHtml(entry.term)}</span>
              <div class="dictionary-card-actions">
                <button onclick="toggleDictEntry(${i})">${toggleLabel}</button>
                <button onclick="openDictEditor(${i})">✎</button>
                <button onclick="deleteDictEntry(${i})">✕</button>
              </div>
            </div>
          </div>`;
        }).join('');
      }
    }

    async function toggleDictionary() {
      polishConfig.dictionary.enabled = document.getElementById('dictToggle').checked;
      await savePolishSettings();
    }

    function openDictEditor(index) {
      editingDictIndex = index;
      const titleEl = document.getElementById('dictEditorTitle');
      if (index >= 0) {
        const entry = polishConfig.dictionary.entries[index];
        titleEl.textContent = t('dictionary.editEntry');
        document.getElementById('dictTermInput').value = entry.term || '';
      } else {
        titleEl.textContent = t('dictionary.addEntry');
        document.getElementById('dictTermInput').value = '';
      }
      document.getElementById('dictEditorOverlay').classList.add('active');
    }

    function closeDictEditor() {
      document.getElementById('dictEditorOverlay').classList.remove('active');
      editingDictIndex = -1;
    }

    async function saveDictEditor() {
      const term = document.getElementById('dictTermInput').value.trim();
      if (!term) {
        document.getElementById('dictTermInput').focus();
        return;
      }
      const entry = { term, enabled: true };
      if (editingDictIndex >= 0) {
        entry.enabled = polishConfig.dictionary.entries[editingDictIndex].enabled;
        polishConfig.dictionary.entries[editingDictIndex] = entry;
      } else {
        polishConfig.dictionary.entries.push(entry);
      }
      closeDictEditor();
      renderDictionary();
      await savePolishSettings();
    }

    async function deleteDictEntry(index) {
      polishConfig.dictionary.entries.splice(index, 1);
      renderDictionary();
      await savePolishSettings();
    }

    async function toggleDictEntry(index) {
      polishConfig.dictionary.entries[index].enabled = !polishConfig.dictionary.entries[index].enabled;
      renderDictionary();
      await savePolishSettings();
    }

    // ── Mic status ──

    async function loadMicStatus() {
      try {
        const status = await invoke('get_mic_status');
        const dot = document.getElementById('micDot');
        const name = document.getElementById('micDeviceName');
        const desc = document.getElementById('micDeviceDesc');
        const select = document.getElementById('micSelect');

        // Populate the select with device names
        select.innerHTML = '';
        const autoOpt = document.createElement('option');
        autoOpt.value = 'auto';
        autoOpt.textContent = status.default_device
          ? t('settings.mic.auto') + ' (' + status.default_device + ')'
          : t('settings.mic.auto');
        select.appendChild(autoOpt);

        for (const dev of status.devices) {
          if (dev === status.default_device) continue; // already shown in Auto
          const opt = document.createElement('option');
          opt.value = dev;
          opt.textContent = dev;
          select.appendChild(opt);
        }
        select.value = 'auto';

        if (status.connected) {
          dot.classList.remove('disconnected');
          name.textContent = t('settings.mic.inputDevice');
          name.classList.remove('disconnected');
          const n = status.devices.length;
          desc.textContent = t('settings.mic.devicesAvailable', { n: n, s: n !== 1 ? 's' : '' });
          select.disabled = false;
        } else {
          dot.classList.add('disconnected');
          name.textContent = t('settings.mic.noMic');
          name.classList.add('disconnected');
          desc.textContent = t('settings.mic.noMicDesc');
          select.disabled = true;
        }
      } catch (e) {
        console.error('Failed to get mic status:', e);
      }
    }

    // ── Setup overlay (first-launch model download) ──

    let setupUnlisten = null;

    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
    }

    function showSetupState(stateId) {
      document.querySelectorAll('#setupOverlay .setup-state').forEach(s => s.classList.remove('active'));
      document.getElementById(stateId).classList.add('active');
    }

    function showSetupOverlay() {
      const overlay = document.getElementById('setupOverlay');
      overlay.style.display = '';
      overlay.classList.remove('fade-out');
      showSetupState('setupInitial');
    }

    function hideSetupOverlay() {
      stopPermissionPolling();
      const overlay = document.getElementById('setupOverlay');
      overlay.classList.add('fade-out');
      setTimeout(() => {
        overlay.style.display = 'none';
        overlay.classList.remove('fade-out');
      }, 300);
      if (setupUnlisten) {
        setupUnlisten();
        setupUnlisten = null;
      }
    }

    // ── Permissions onboarding ──

    let permPollTimer = null;

    async function checkPermissions() {
      try {
        return await invoke('check_permissions');
      } catch (e) {
        console.error('Failed to check permissions:', e);
        // Fallback: assume granted so user can still proceed
        return { microphone: 'granted', accessibility: true };
      }
    }

    function updatePermissionUI(perms) {
      const grantedHtml = '<div class="setup-permission-granted"><svg viewBox="0 0 14 14" fill="none"><path d="M2.5 7.5L5.5 10.5L11.5 4.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>';
      const micGranted = perms.microphone === 'granted';
      const accGranted = perms.accessibility === true;

      const micAction = document.getElementById('permMicAction');
      if (micGranted) {
        micAction.innerHTML = grantedHtml;
      } else {
        micAction.innerHTML = '<button class="setup-permission-btn" onclick="openPermSettings(\'microphone\')" data-i18n="setup.permGrant">' + t('setup.permGrant') + '</button>';
      }

      const accAction = document.getElementById('permAccAction');
      if (accGranted) {
        accAction.innerHTML = grantedHtml;
      } else {
        accAction.innerHTML = '<button class="setup-permission-btn" onclick="openPermSettings(\'accessibility\')" data-i18n="setup.permGrant">' + t('setup.permGrant') + '</button>';
      }

      const continueBtn = document.getElementById('permContinueBtn');
      continueBtn.disabled = !(micGranted && accGranted);
    }

    async function openPermSettings(type) {
      try {
        await invoke('open_permission_settings', { permissionType: type });
      } catch (e) {
        console.error('Failed to open permission settings:', e);
      }
    }

    function startPermissionPolling() {
      stopPermissionPolling();
      permPollTimer = setInterval(async () => {
        const perms = await checkPermissions();
        updatePermissionUI(perms);
      }, 1500);
    }

    function stopPermissionPolling() {
      if (permPollTimer) {
        clearInterval(permPollTimer);
        permPollTimer = null;
      }
    }

    async function permissionsContinue() {
      stopPermissionPolling();
      // Check if model needs download
      try {
        const status = await invoke('check_model_status');
        if (status.engine === 'whisper' && !status.model_exists) {
          showSetupState('setupInitial');
        } else {
          hideSetupOverlay();
        }
      } catch (e) {
        console.error('Failed to check model status:', e);
        hideSetupOverlay();
      }
    }

    async function showSetupWithPermCheck() {
      const perms = await checkPermissions();
      const overlay = document.getElementById('setupOverlay');
      overlay.style.display = '';
      overlay.classList.remove('fade-out');
      showSetupState('setupPermissions');
      updatePermissionUI(perms);
      startPermissionPolling();
    }

    async function checkFirstLaunch() {
      try {
        const status = await invoke('check_model_status');
        const needsModel = status.engine === 'whisper' && !status.model_exists;
        if (needsModel) {
          // Always show permissions page first before model download
          const perms = await checkPermissions();
          const overlay = document.getElementById('setupOverlay');
          overlay.style.display = '';
          overlay.classList.remove('fade-out');
          showSetupState('setupPermissions');
          updatePermissionUI(perms);
          startPermissionPolling();
        }
      } catch (e) {
        console.error('Failed to check first launch:', e);
      }
    }

    async function startModelDownload() {
      showSetupState('setupDownloading');
      document.getElementById('setupProgressFill').style.width = '0%';
      document.getElementById('setupProgressPercent').textContent = '0%';
      document.getElementById('setupProgressSize').textContent = '0 MB / 0 MB';

      setupUnlisten = await window.__TAURI__.event.listen('model-download-progress', (e) => {
        const d = e.payload;
        if (d.status === 'downloading') {
          const pct = Math.min(d.percent, 100).toFixed(1);
          document.getElementById('setupProgressFill').style.width = pct + '%';
          document.getElementById('setupProgressPercent').textContent = Math.round(d.percent) + '%';
          document.getElementById('setupProgressSize').textContent =
            formatBytes(d.downloaded) + ' / ' + formatBytes(d.total);
        } else if (d.status === 'complete') {
          showSetupState('setupComplete');
          // After 1.5s, show polish choice screen
          setTimeout(() => {
            showSetupState('setupPolishChoice');
          }, 1500);
        } else if (d.status === 'error') {
          document.getElementById('setupErrorMsg').textContent = d.message || t('setup.errorDefault');
          showSetupState('setupError');
        }
      });

      try {
        await invoke('download_model');
      } catch (e) {
        document.getElementById('setupErrorMsg').textContent = e.toString();
        showSetupState('setupError');
      }
    }

    let setupLlmUnlisten = null;

    async function startSetupLlmDownload() {
      showSetupState('setupLlmDownloading');
      document.getElementById('setupLlmProgressFill').style.width = '0%';
      document.getElementById('setupLlmProgressPercent').textContent = '0%';
      document.getElementById('setupLlmProgressSize').textContent = '0 MB / 0 MB';

      if (setupLlmUnlisten) {
        setupLlmUnlisten();
        setupLlmUnlisten = null;
      }

      setupLlmUnlisten = await window.__TAURI__.event.listen('llm-model-download-progress', (e) => {
        const d = e.payload;
        if (d.status === 'downloading') {
          const pct = Math.min(d.percent, 100).toFixed(1);
          document.getElementById('setupLlmProgressFill').style.width = pct + '%';
          document.getElementById('setupLlmProgressPercent').textContent = Math.round(d.percent) + '%';
          document.getElementById('setupLlmProgressSize').textContent =
            formatBytes(d.downloaded) + ' / ' + formatBytes(d.total);
        } else if (d.status === 'complete') {
          showSetupState('setupComplete');
          if (setupLlmUnlisten) {
            setupLlmUnlisten();
            setupLlmUnlisten = null;
          }
          setTimeout(() => hideSetupOverlay(), 1500);
        } else if (d.status === 'error') {
          console.error('LLM setup download error:', d.message);
          // On error, just close the overlay — user can download from settings later
          hideSetupOverlay();
          if (setupLlmUnlisten) {
            setupLlmUnlisten();
            setupLlmUnlisten = null;
          }
        }
      });

      try {
        await invoke('download_llm_model');
      } catch (e) {
        console.error('Failed to start LLM setup download:', e);
        hideSetupOverlay();
      }
    }

    function skipLlmDownload() {
      hideSetupOverlay();
    }

    function selectSetupPolishMode(mode) {
      const btns = document.querySelectorAll('.setup-polish-mode-control button');
      btns.forEach(b => b.classList.remove('active'));
      btns[mode === 'local' ? 0 : 1].classList.add('active');
      document.getElementById('setupPolishLocalPanel').style.display = mode === 'local' ? '' : 'none';
      document.getElementById('setupPolishCloudPanel').style.display = mode === 'cloud' ? '' : 'none';
    }

    async function setupChooseCloud() {
      polishConfig.mode = 'cloud';
      polishConfig.enabled = true;
      try {
        await invoke('save_settings', { newSettings: buildSettingsPayload() });
      } catch (e) {
        console.error('Failed to save cloud polish settings:', e);
      }
      hideSetupOverlay();
    }

    // ── Test Wizard ──

    let testStep = 1;
    let testMicStream = null;
    let testAudioCtx = null;
    let testWaveAnimId = null;
    let testHotkeyUnlisten = null;

    function startTestWizard() {
      testStep = 1;
      goToTestStep(1);
    }

    function cleanupTestWizard() {
      // Stop mic stream
      if (testMicStream) {
        testMicStream.getTracks().forEach(t => t.stop());
        testMicStream = null;
      }
      if (testAudioCtx) {
        testAudioCtx.close().catch(() => {});
        testAudioCtx = null;
      }
      if (testWaveAnimId) {
        cancelAnimationFrame(testWaveAnimId);
        testWaveAnimId = null;
      }
      // Unlisten hotkey event
      if (testHotkeyUnlisten) {
        testHotkeyUnlisten();
        testHotkeyUnlisten = null;
      }
      // Clean up Try It listeners
      cleanupGeneral();
      cleanupGmail();
      // Ensure test mode is disabled when leaving the wizard
      invoke('set_test_mode', { enabled: false }).catch(() => {});
    }

    function goToTestStep(n) {
      testStep = n;

      // Update breadcrumb
      for (let i = 1; i <= 4; i++) {
        const bc = document.getElementById('testBc' + i);
        bc.classList.remove('active', 'done');
        if (i === n) bc.classList.add('active');
        else if (i < n) bc.classList.add('done');
      }

      // Update progress bar
      document.getElementById('testProgressFill').style.width = (n / 4 * 100) + '%';

      // Show/hide steps
      for (let i = 1; i <= 4; i++) {
        const step = document.getElementById('testStep' + i);
        step.classList.toggle('active', i === n);
      }

      // Setup each step
      if (n === 1) setupMicTest();
      else cleanupMicTest();

      if (n === 2) setupHotkeyTest();
      else cleanupHotkeyTest();

      if (n === 3) setupGeneral();
      else cleanupGeneral();

      if (n === 4) setupGmail();
      else cleanupGmail();
    }

    function testGoBack(fromStep) {
      if (fromStep === 1) {
        switchPage('settings');
      } else {
        goToTestStep(fromStep - 1);
      }
    }

    // -- Step 1: Mic Test --

    function setupMicTest() {
      cleanupMicTest();
      const canvas = document.getElementById('testMicCanvas');
      const container = canvas.closest('.test-right');
      if (!container) return;

      // Size canvas to match the grey container
      const dpr = window.devicePixelRatio || 1;
      const cRect = container.getBoundingClientRect();
      const drawW = Math.round(cRect.width);
      const drawH = Math.round(cRect.height);
      canvas.width = drawW * dpr;
      canvas.height = drawH * dpr;
      canvas.style.width = drawW + 'px';
      canvas.style.height = drawH + 'px';
      const ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);

      const hPad = 20;
      const availW = drawW - hPad * 2;
      const barWidth = 4;
      const barGap = 3;
      const NUM_BARS = Math.floor((availW + barGap) / (barWidth + barGap));
      const maxBarH = Math.min(drawH * 0.4, 120);

      // Draw idle bars
      drawBars(ctx, NUM_BARS, barWidth, barGap, new Float32Array(NUM_BARS), maxBarH, drawW, drawH);

      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        testMicStream = stream;
        testAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = testAudioCtx.createMediaStreamSource(stream);
        const analyser = testAudioCtx.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);

        const dataArray = new Uint8Array(analyser.frequencyBinCount);

        function animate() {
          testWaveAnimId = requestAnimationFrame(animate);
          analyser.getByteFrequencyData(dataArray);

          // Compute per-bar levels
          const levels = new Float32Array(NUM_BARS);
          const step = Math.max(1, Math.floor(dataArray.length / NUM_BARS));
          for (let i = 0; i < NUM_BARS; i++) {
            let sum = 0;
            for (let j = 0; j < step; j++) {
              sum += dataArray[i * step + j];
            }
            levels[i] = (sum / step) / 255;
          }

          drawBars(ctx, NUM_BARS, barWidth, barGap, levels, maxBarH, drawW, drawH);
        }
        animate();
      }).catch(err => {
        console.warn('Mic access denied for test:', err);
      });
    }

    function drawBars(ctx, numBars, barWidth, barGap, levels, maxBarH, w, h) {
      ctx.clearRect(0, 0, w, h);
      const totalW = numBars * barWidth + (numBars - 1) * barGap;
      const startX = (w - totalW) / 2;
      const cy = h / 2;

      for (let i = 0; i < numBars; i++) {
        const level = levels[i] || 0;
        const h = Math.max(4, level * maxBarH);
        const x = startX + i * (barWidth + barGap);
        const y = cy - h / 2;
        ctx.fillStyle = level > 0.05 ? '#007AFF' : '#e0e0e0';
        ctx.beginPath();
        ctx.roundRect(x, y, barWidth, h, barWidth / 2);
        ctx.fill();
      }
    }

    function cleanupMicTest() {
      if (testMicStream) {
        testMicStream.getTracks().forEach(t => t.stop());
        testMicStream = null;
      }
      if (testAudioCtx) {
        testAudioCtx.close().catch(() => {});
        testAudioCtx = null;
      }
      if (testWaveAnimId) {
        cancelAnimationFrame(testWaveAnimId);
        testWaveAnimId = null;
      }
    }

    // -- Step 2: Hotkey Test --

    // Map DOM KeyboardEvent to hotkey part names
    function eventToHotkeyParts(e) {
      const held = new Set();
      if (e.altKey) held.add('Alt');
      if (e.ctrlKey) held.add('Control');
      if (e.shiftKey) held.add('Shift');
      if (e.metaKey) held.add('Super');
      // Map e.code for non-modifier keys
      const code = e.code;
      if (code && !['AltLeft','AltRight','ControlLeft','ControlRight','ShiftLeft','ShiftRight','MetaLeft','MetaRight'].includes(code)) {
        held.add(code);
      }
      return held;
    }

    function testHotkeyKeydown(e) {
      e.preventDefault();
      const held = eventToHotkeyParts(e);
      const parts = currentHotkey.split('+');
      const container = document.getElementById('testHotkeyKeycaps');
      if (!container) return;
      const kbds = container.querySelectorAll('kbd');
      parts.forEach((part, i) => {
        if (held.has(part)) {
          kbds[i]?.classList.add('pressed');
        }
      });
    }

    function testHotkeyKeyup(e) {
      e.preventDefault();
      const held = eventToHotkeyParts(e);
      const parts = currentHotkey.split('+');
      const container = document.getElementById('testHotkeyKeycaps');
      if (!container) return;
      const kbds = container.querySelectorAll('kbd');
      parts.forEach((part, i) => {
        if (!held.has(part)) {
          kbds[i]?.classList.remove('pressed');
        }
      });
    }

    async function setupHotkeyTest() {
      cleanupHotkeyTest();
      const container = document.getElementById('testHotkeyKeycaps');
      renderKeycaps(container, currentHotkey);

      // Show hotkey in subtitle
      const parts = currentHotkey.split('+');
      const label = parts.map(p => modifierSymbols[p] || keyCodeToLabel(p)).join(' + ');
      document.getElementById('testHotkeySubtitle').textContent =
        t('test.step2.subtitle', { hotkey: label });

      // Enable test mode so the hotkey does NOT start recording
      try { await invoke('set_test_mode', { enabled: true }); } catch (e) { console.warn('set_test_mode failed:', e); }

      // Per-key highlighting via DOM keyboard events
      document.addEventListener('keydown', testHotkeyKeydown);
      document.addEventListener('keyup', testHotkeyKeyup);

      // Listen for hotkey-activated event from backend (full combo confirmation)
      window.__TAURI__.event.listen('hotkey-activated', () => {
        const kc = document.getElementById('testHotkeyKeycaps');
        kc.classList.add('active');
        setTimeout(() => kc.classList.remove('active'), 600);
      }).then(unlisten => {
        testHotkeyUnlisten = unlisten;
      });
    }

    async function cleanupHotkeyTest() {
      document.removeEventListener('keydown', testHotkeyKeydown);
      document.removeEventListener('keyup', testHotkeyKeyup);
      if (testHotkeyUnlisten) {
        testHotkeyUnlisten();
        testHotkeyUnlisten = null;
      }
      // Disable test mode so normal recording works again
      try { await invoke('set_test_mode', { enabled: false }); } catch (e) { console.warn('set_test_mode failed:', e); }
    }

    // -- Test paste de-duplication --
    // The backend inserts text via the `transcription-result` Tauri event AND
    // simulates Cmd+V (for real apps).  When the paste target is our own
    // contenteditable, both paths fire and text appears twice.  We suppress
    // the redundant Cmd+V paste for a short window after the event-based insert.
    let _suppressPasteUntil = 0;

    function suppressNextPaste() {
      _suppressPasteUntil = Date.now() + 1000;
    }

    document.addEventListener('paste', (e) => {
      if (Date.now() < _suppressPasteUntil) {
        e.preventDefault();
        e.stopImmediatePropagation();
      }
    }, true);  // capture phase — fires before contenteditable's default handler

    // -- Step 3: General (no app context) --

    let testGeneralUnlisten = null;

    async function setupGeneral() {
      const parts = currentHotkey.split('+');
      const label = parts.map(p => modifierSymbols[p] || keyCodeToLabel(p)).join(' + ');
      const instrEl = document.getElementById('testGeneralInstruction');
      if (instrEl) instrEl.innerHTML = t('test.step3.instruction', { hotkey: label });

      // Disable test mode — let the hotkey actually record + transcribe
      try { await invoke('set_test_mode', { enabled: false }); } catch (e) {}

      // No context override — general scenario
      try {
        await invoke('set_context_override', { appName: '', bundleId: '', url: '' });
      } catch (e) { console.warn('set_context_override failed:', e); }

      // Reset plain body
      const body = document.getElementById('testPlainBody');
      if (body) body.innerHTML = '';

      // Listen for transcription result and insert into the plain editor
      cleanupGeneral();
      window.__TAURI__.event.listen('transcription-result', (event) => {
        const text = event.payload;
        if (!text) return;
        const body = document.getElementById('testPlainBody');
        if (!body) return;

        suppressNextPaste();

        const sel = window.getSelection();
        if (sel && sel.rangeCount > 0 && body.contains(sel.anchorNode)) {
          const range = sel.getRangeAt(0);
          range.deleteContents();
          range.insertNode(document.createTextNode(text));
          range.collapse(false);
          sel.removeAllRanges();
          sel.addRange(range);
        } else {
          body.focus();
          body.innerHTML += escapeHtml(text);
        }
      }).then(unlisten => {
        testGeneralUnlisten = unlisten;
      });
    }

    function cleanupGeneral() {
      if (testGeneralUnlisten) {
        testGeneralUnlisten();
        testGeneralUnlisten = null;
      }
    }

    // -- Step 4: Gmail scenario --

    let testGmailUnlisten = null;

    async function setupGmail() {
      const parts = currentHotkey.split('+');
      const label = parts.map(p => modifierSymbols[p] || keyCodeToLabel(p)).join(' + ');
      const instrEl = document.getElementById('testTryInstruction');
      if (instrEl) instrEl.innerHTML = t('test.step4.instruction', { hotkey: label });

      // Disable test mode — let the hotkey actually record + transcribe
      try { await invoke('set_test_mode', { enabled: false }); } catch (e) {}

      // Clean up previous Gmail listener (must happen before setting context override,
      // because cleanupGmail() also clears the context override)
      cleanupGmail();

      // Set context override so polisher uses Gmail prompt rule
      try {
        await invoke('set_context_override', {
          appName: 'Google Chrome',
          bundleId: 'com.google.Chrome',
          url: 'https://mail.google.com/mail/u/0/#inbox?compose=new',
        });
      } catch (e) { console.warn('set_context_override failed:', e); }

      // Reset Gmail body
      const body = document.getElementById('testGmailBody');
      if (body) body.innerHTML = '';
      window.__TAURI__.event.listen('transcription-result', (event) => {
        const text = event.payload;
        if (!text) return;
        const body = document.getElementById('testGmailBody');
        if (!body) return;
        suppressNextPaste();

        // Convert newlines to <br> for contenteditable
        const frag = document.createDocumentFragment();
        const lines = text.split('\n');
        lines.forEach((line, i) => {
          if (i > 0) frag.appendChild(document.createElement('br'));
          if (line) frag.appendChild(document.createTextNode(line));
        });

        const sel = window.getSelection();
        if (sel && sel.rangeCount > 0 && body.contains(sel.anchorNode)) {
          const range = sel.getRangeAt(0);
          range.deleteContents();
          range.insertNode(frag);
          range.collapse(false);
          sel.removeAllRanges();
          sel.addRange(range);
        } else {
          body.focus();
          body.innerHTML += escapeHtml(text).replace(/\n/g, '<br>');
        }
      }).then(unlisten => {
        testGmailUnlisten = unlisten;
      });
    }

    function cleanupGmail() {
      if (testGmailUnlisten) {
        testGmailUnlisten();
        testGmailUnlisten = null;
      }
      invoke('set_context_override', { appName: '', bundleId: '', url: '' }).catch(() => {});
    }

    // ── History ──

    let openHistoryMenuId = null;

    async function loadHistorySettings() {
      try {
        const settings = await invoke('get_settings');
        const sel = document.getElementById('historyRetentionSelect');
        if (sel) sel.value = String(settings.history_retention_days || 0);
      } catch (e) {
        console.error('Failed to load history settings:', e);
      }
      try {
        const storagePath = await invoke('get_history_storage_path');
        const el = document.getElementById('historyStoragePath');
        if (el) el.textContent = storagePath || '-';
      } catch (e) {
        console.error('Failed to load storage path:', e);
      }
    }

    async function onRetentionChange() {
      const sel = document.getElementById('historyRetentionSelect');
      const days = parseInt(sel.value, 10);
      try {
        const settings = await invoke('get_settings');
        settings.history_retention_days = days;
        await invoke('save_settings', { newSettings: settings });
      } catch (e) {
        console.error('Failed to save retention setting:', e);
      }
    }

    function revealStoragePath() {
      const el = document.getElementById('historyStoragePath');
      if (el && el.textContent && el.textContent !== '-') {
        // Copy path to clipboard as a convenience
        navigator.clipboard.writeText(el.textContent).catch(() => {});
        el.style.borderColor = 'var(--accent-green)';
        setTimeout(() => { el.style.borderColor = ''; }, 800);
      }
    }

    async function loadHistory() {
      const container = document.getElementById('historyList');
      try {
        const entries = await invoke('get_history');
        if (!entries || entries.length === 0) {
          container.innerHTML = `
            <div class="history-empty">
              <div class="history-empty-icon">&#128196;</div>
              <div class="history-empty-text">${escapeHtml(t('history.emptyTitle'))}</div>
              <div class="history-empty-hint">${escapeHtml(t('history.emptyHint'))}</div>
            </div>`;
          return;
        }

        // Group by date
        const groups = {};
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        for (const entry of entries) {
          const d = new Date(entry.timestamp);
          const day = new Date(d);
          day.setHours(0, 0, 0, 0);
          let label;
          if (day.getTime() === today.getTime()) {
            label = t('history.today');
          } else if (day.getTime() === yesterday.getTime()) {
            label = t('history.yesterday');
          } else {
            label = d.toLocaleDateString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit' });
          }
          if (!groups[label]) groups[label] = [];
          groups[label].push(entry);
        }

        let html = '';
        for (const [dateLabel, items] of Object.entries(groups)) {
          html += `<div class="history-date-group">`;
          html += `<div class="history-date-header">${dateLabel}</div>`;
          for (const item of items) {
            const d = new Date(item.timestamp);
            const time = d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', hour12: false });
            const dur = item.duration_secs.toFixed(1);
            const escapedText = escapeHtml(item.text);
            const hasRaw = item.raw_text && item.raw_text !== item.text;
            const clickable = hasRaw ? ' clickable' : '';
            const clickHandler = hasRaw ? ` onclick="openHistoryDetail('${item.id}')"` : '';
            html += `
              <div class="history-entry${clickable}" id="hentry-${item.id}"${clickHandler} data-raw="${hasRaw ? escapeAttr(item.raw_text) : ''}" data-polished="${hasRaw ? escapeAttr(item.text) : ''}">
                <div class="history-time">${time}</div>
                <div class="history-content">
                  <div class="history-text">${escapedText}</div>
                  <div class="history-meta">
                    <span class="history-meta-item">${dur}s</span>
                    <span class="history-meta-item">STT: ${escapeHtml(item.stt_model)}</span>
                    ${item.polish_model !== 'None' ? `<span class="history-meta-item">Polish: ${escapeHtml(item.polish_model)}</span>` : ''}
                  </div>
                </div>
                <button class="history-menu-btn" onclick="toggleHistoryMenu(event, '${item.id}')" title="More">&#8943;</button>
                <div class="history-menu" id="hmenu-${item.id}">
                  ${item.has_audio ? `<button class="history-menu-item" onclick="exportHistoryAudio('${item.id}')">${escapeHtml(t('history.downloadAudio'))}</button>` : ''}
                  <button class="history-menu-item destructive" onclick="deleteHistoryEntry('${item.id}')">${escapeHtml(t('history.delete'))}</button>
                </div>
              </div>`;
          }
          html += `</div>`;
        }
        container.innerHTML = html;
      } catch (e) {
        console.error('Failed to load history:', e);
        container.innerHTML = `
          <div class="history-empty">
            <div class="history-empty-icon">&#9888;</div>
            <div class="history-empty-text">${escapeHtml(t('history.errorTitle'))}</div>
            <div class="history-empty-hint">${escapeHtml(String(e))}</div>
          </div>`;
      }
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function openHistoryDetail(id) {
      const entry = document.getElementById('hentry-' + id);
      if (!entry) return;
      document.getElementById('historyDetailRaw').textContent = entry.dataset.raw;
      document.getElementById('historyDetailPolished').textContent = entry.dataset.polished;
      document.getElementById('historyDetailOverlay').classList.add('active');
    }

    function closeHistoryDetail() {
      document.getElementById('historyDetailOverlay').classList.remove('active');
    }

    function toggleHistoryMenu(event, id) {
      event.stopPropagation();
      const menu = document.getElementById('hmenu-' + id);
      if (!menu) return;

      if (openHistoryMenuId && openHistoryMenuId !== id) {
        const prev = document.getElementById('hmenu-' + openHistoryMenuId);
        if (prev) prev.classList.remove('visible');
      }

      menu.classList.toggle('visible');
      openHistoryMenuId = menu.classList.contains('visible') ? id : null;
    }

    // Close menu on outside click
    document.addEventListener('click', () => {
      if (openHistoryMenuId) {
        const menu = document.getElementById('hmenu-' + openHistoryMenuId);
        if (menu) menu.classList.remove('visible');
        openHistoryMenuId = null;
      }
    });

    async function deleteHistoryEntry(id) {
      // Close menu
      const menu = document.getElementById('hmenu-' + id);
      if (menu) menu.classList.remove('visible');
      openHistoryMenuId = null;

      try {
        await invoke('delete_history_entry', { id });
        loadHistory();
      } catch (e) {
        console.error('Failed to delete history entry:', e);
      }
    }

    async function clearAllHistory() {
      const ok = await showConfirm(
        t('history.clearAll'),
        t('history.clearAllConfirm')
      );
      if (!ok) return;
      try {
        await invoke('clear_all_history');
        loadHistory();
      } catch (e) {
        console.error('Failed to clear history:', e);
      }
    }

    async function exportHistoryAudio(id) {
      // Close menu
      const menu = document.getElementById('hmenu-' + id);
      if (menu) menu.classList.remove('visible');
      openHistoryMenuId = null;

      try {
        const path = await invoke('export_history_audio', { id });
        // Brief visual feedback — flash the entry background
        const entry = document.getElementById('hentry-' + id);
        if (entry) {
          entry.style.background = 'rgba(52, 199, 89, 0.1)';
          setTimeout(() => { entry.style.background = ''; }, 1000);
        }
        console.log('Audio exported to:', path);
      } catch (e) {
        console.error('Failed to export audio:', e);
      }
    }

    // ── Update ──
    let pendingUpdate = null;

    async function checkForUpdates() {
      const btn = document.getElementById('updateBtn');
      const status = document.getElementById('updateStatus');
      const progress = document.getElementById('updateProgress');
      const note = document.getElementById('updateNote');

      // Reset UI
      status.className = 'about-update-status';
      status.style.display = 'block';
      status.textContent = t('about.checking');
      progress.style.display = 'none';
      note.style.display = 'none';
      btn.disabled = true;
      btn.textContent = t('about.checking');

      try {
        const { check } = window.__TAURI__.updater;
        const update = await check();

        if (update) {
          pendingUpdate = update;
          status.textContent = t('about.updateAvailable', { version: update.version });
          btn.textContent = t('about.download');
          btn.disabled = false;
          btn.classList.add('primary');
          btn.onclick = downloadAndInstallUpdate;
        } else {
          status.textContent = t('about.upToDate');
          btn.textContent = t('about.checkUpdate');
          btn.disabled = false;
          btn.onclick = checkForUpdates;
        }
      } catch (e) {
        console.error('Update check failed:', e);
        status.textContent = t('about.updateError');
        status.classList.add('error');
        btn.textContent = t('about.retry');
        btn.disabled = false;
        btn.onclick = checkForUpdates;
      }
    }

    async function downloadAndInstallUpdate() {
      if (!pendingUpdate) return;

      const btn = document.getElementById('updateBtn');
      const status = document.getElementById('updateStatus');
      const progress = document.getElementById('updateProgress');
      const progressBar = document.getElementById('updateProgressBar');
      const note = document.getElementById('updateNote');

      btn.style.display = 'none';
      status.textContent = t('about.downloading', { percent: '0' });
      progress.style.display = 'block';
      progressBar.style.width = '0%';

      try {
        let downloaded = 0;
        let contentLength = 0;

        await pendingUpdate.downloadAndInstall((event) => {
          switch (event.event) {
            case 'Started':
              contentLength = event.data.contentLength || 0;
              break;
            case 'Progress':
              downloaded += event.data.chunkLength;
              if (contentLength > 0) {
                const pct = Math.min(100, Math.round((downloaded / contentLength) * 100));
                progressBar.style.width = pct + '%';
                status.textContent = t('about.downloading', { percent: String(pct) });
              }
              break;
            case 'Finished':
              break;
          }
        });

        // Download & install complete
        progress.style.display = 'none';
        status.textContent = t('about.readyToRestart');
        note.textContent = t('about.gatekeeperNote');
        note.style.display = 'block';

        btn.style.display = '';
        btn.textContent = t('about.restartNow');
        btn.disabled = false;
        btn.classList.add('primary');
        btn.onclick = () => {
          window.__TAURI__.process.relaunch();
        };
      } catch (e) {
        console.error('Update download failed:', e);
        progress.style.display = 'none';
        status.textContent = t('about.updateError');
        status.classList.add('error');
        btn.style.display = '';
        btn.textContent = t('about.retry');
        btn.disabled = false;
        btn.classList.remove('primary');
        btn.onclick = checkForUpdates;
      }
    }

    // ── Init ──
    document.addEventListener('DOMContentLoaded', () => {
      loadSettings().then(() => checkFirstLaunch());
      loadMicStatus();

      // Poll mic status every 3 seconds so the UI stays in sync
      setInterval(loadMicStatus, 3000);

      // Also refresh immediately when the window becomes visible
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) loadMicStatus();
      });
    });
  </script>
</body>
</html>
